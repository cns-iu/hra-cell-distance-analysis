# Distance Analysis: colon-xenium-stanford and colon-cycif-sorgerlab


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

``` python
import numpy as np
import pandas as pd
import os
import json
import requests
import shutil
import matplotlib.pyplot as plt
import seaborn as sns
from sklearn.preprocessing import normalize
import plotly.express as px

from _cde_compute_edges_from_nodes import *

pd.set_option('display.max_columns', None)
pd.set_option('display.max_rows', None)

# suppress warnings
import warnings
warnings.filterwarnings("ignore")
```

``` python
basepath = "/u/yashjain/hra-cell-distance-analysis/data"
dataset_dir = "colon-cycif-sorgerlab-xenium-stanford" # This variable is used only for figures. 
dataset_dir_1 = "colon-xenium-stanford" # This variable is used for data loading dataset 1.
dataset_dir_2 = "colon-cycif-sorgerlab" # This variable is used for data loading dataset 2.
data_filedir_1 = os.path.join("data-processed-nodes-with-harmonized-cell-types", dataset_dir_1)
output_edge_dir_1 = os.path.join("data-processed-edges", dataset_dir_1)
data_filedir_2 = os.path.join("data-processed-nodes-with-harmonized-cell-types", dataset_dir_2)
output_edge_dir_2 = os.path.join("data-processed-edges", dataset_dir_2)
figures_output_dir = "generated-figures"
```

``` python
# Function to load your data
def load_data(path, edges=False):
    if edges:
        column_names = ['cell_id', 'x1', 'y1', 'z1', 'x2', 'y2', 'z2']
        data = pd.read_csv(path, header=None, names=column_names)
    else:
        data = pd.read_csv(path)
    return data
```

``` python
# Function to read all files ending with "-nodes.csv" in the `data_filedir` directory into a single DataFrame. 
# Another additional column `Dataset` is added to identify the dataset name which comes from the filename before the `-nodes.csv` suffix.

# Additionally, function reads all files ending with "-edges.csv" in the `output_edge_dir` directory into a single DataFrame. 
# Three additional columns are added "Dataset", "Anchor Cell Type", and "Anchor Cell Type Level" to identify the dataset name, anchor cell type, and anchor cell type level respectively which come from the filename before the `.csv` suffix.
# The three additional columns are created by splitting the filename on the `-` character, and extracting the relevant parts.
# On splitting, the first part is the dataset name, second part is the anchor cell type level, and third part is the anchor cell type, and last part is the `edges` suffix.
# When reading files, check if the file has the correct format (i.e., ends with `-edges.csv`).

# Additionally, the function merges the edges DataFrame with the nodes DataFrame to get the cell type information for the anchor cells.
# This is done by reading the corresponding nodes file from the `data_filedir` directory for each edges file, and merging it with the edges DataFrame on the `cell_id` column.
# The merged DataFrame contains the edges with additional columns for the cell type information.

# The function returns three DataFrames:
# 1. `merged_nodes`: DataFrame containing all nodes with an additional column `Dataset`.
# 2. `merged_edges`: DataFrame containing all edges with additional columns `Dataset`, `Anchor Cell Type`, and `Anchor Cell Type Level`.
# 3. `merged_nodes_for_all_edges`: DataFrame containing all edges with additional columns `Dataset`, `Anchor Cell Type`, `Anchor Cell Type Level`, and the cell type information for cells.
def read_all_edge_datasets(basepath, data_filedir, output_edge_dir):
    all_nodes_files = []
    all_edges_files = []
    all_nodes_edges_files = []
    for file in os.listdir(os.path.join(basepath, output_edge_dir)):
        if file.endswith("-edges.csv"):
            file_path = os.path.join(basepath, output_edge_dir, file)
            dataset_name, anchor_cell_type_level, anchor_cell_type = file.replace("-edges.csv", "").split('-')
            edges_df = load_data(file_path, edges=False)
            edges_df['Dataset'] = dataset_name
            edges_df['Anchor Cell Type'] = anchor_cell_type
            edges_df['Anchor Cell Type Level'] = anchor_cell_type_level
            edges_df.rename(columns={"distance": "Distance"}, inplace=True) # Rename column "distance" to "Distance".
            all_edges_files.append(edges_df)

            # Read the corresponding nodes file from data_filedir to get the cell type information
            nodes_file_path = os.path.join(basepath, data_filedir, f"{dataset_name}-nodes.csv")
            nodes_df = load_data(nodes_file_path)
            nodes_df['Dataset'] = dataset_name
            all_nodes_files.append(nodes_df)

            # Add a new 'cell_id' column to nodes_df
            nodes_df['cell_id'] = range(len(nodes_df))
            # Set 'cell_id' column as index for nodes_df
            nodes_df.set_index('cell_id', inplace=True)
            # Merge edges_df with nodes_df to get the cell type information for the anchor cells
            edges_nodes_df = pd.merge(edges_df, nodes_df[['Level Three Cell Type', 'Level Two Cell Type', 'Level One Cell Type']], how='left', left_on='cell_id', right_index=True)
            all_nodes_edges_files.append(edges_nodes_df)

    
    merged_edges = pd.concat(all_edges_files, ignore_index=True)
    merged_nodes = pd.concat(all_nodes_files, ignore_index=True)
    merged_nodes_for_all_edges = pd.concat(all_nodes_edges_files, ignore_index=True) 

    return merged_nodes, merged_edges, merged_nodes_for_all_edges
```

``` python
def create_directory(directory):
    if not os.path.exists(directory):
        os.makedirs(directory)
        print(f"Directory '{directory}' created successfully.")
    else:
        print(f"Directory '{directory}' already exists.")
```

## Get initial statistics and identify endothelial cell categories for dataset.

``` python
# Read all datasets from Dataset 1
df_all_nodes_1, df_all_edges_1, df_all_edges_with_cell_types_1 = read_all_edge_datasets(basepath, data_filedir_1, output_edge_dir_1)

# Create a column 'Tissue Type' in all three DataFrames with the value dataset_dir_1
df_all_nodes_1['Tissue Type'] = dataset_dir_1
df_all_edges_1['Tissue Type'] = dataset_dir_1
df_all_edges_with_cell_types_1['Tissue Type'] = dataset_dir_1

# Read all datasets from Dataset 2
df_all_nodes_2, df_all_edges_2, df_all_edges_with_cell_types_2 = read_all_edge_datasets(basepath, data_filedir_2, output_edge_dir_2)

# Create a column 'Tissue Type' in all three DataFrames with the value dataset_dir_2
df_all_nodes_2['Tissue Type'] = dataset_dir_2
df_all_edges_2['Tissue Type'] = dataset_dir_2
df_all_edges_with_cell_types_2['Tissue Type'] = dataset_dir_2

# Merge the two datasets
df_all_nodes = pd.concat([df_all_nodes_1, df_all_nodes_2], ignore_index=True)
df_all_edges = pd.concat([df_all_edges_1, df_all_edges_2], ignore_index=True)
df_all_edges_with_cell_types = pd.concat([df_all_edges_with_cell_types_1, df_all_edges_with_cell_types_2], ignore_index=True)
```

``` python
df_all_nodes.head(5)
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&#10;    .dataframe tbody tr th {
        vertical-align: top;
    }
&#10;    .dataframe thead th {
        text-align: right;
    }
</style>

<table class="dataframe" data-quarto-postprocess="true" data-border="1">
<thead>
<tr style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">x</th>
<th data-quarto-table-cell-role="th">y</th>
<th data-quarto-table-cell-role="th">Original Cell Type</th>
<th data-quarto-table-cell-role="th">Level Three Cell Type</th>
<th data-quarto-table-cell-role="th">Level Three CL Label</th>
<th data-quarto-table-cell-role="th">Level Three CL ID</th>
<th data-quarto-table-cell-role="th">CL_Match/3</th>
<th data-quarto-table-cell-role="th">Level Two Cell Type</th>
<th data-quarto-table-cell-role="th">Level Two CL Label</th>
<th data-quarto-table-cell-role="th">Level Two CL ID</th>
<th data-quarto-table-cell-role="th">CL_Match/2</th>
<th data-quarto-table-cell-role="th">Level One Cell Type</th>
<th data-quarto-table-cell-role="th">Level One CL Label</th>
<th data-quarto-table-cell-role="th">Level One CL ID</th>
<th data-quarto-table-cell-role="th">CL_Match/1</th>
<th data-quarto-table-cell-role="th">Dataset</th>
<th data-quarto-table-cell-role="th">Tissue Type</th>
</tr>
</thead>
<tbody>
<tr>
<td data-quarto-table-cell-role="th">0</td>
<td>1077.96</td>
<td>2556.82</td>
<td>Immature Goblet</td>
<td>goblet cell:immature</td>
<td>goblet cell:immature</td>
<td>CL:0000160</td>
<td>skos:narrowMatch</td>
<td>goblet cell</td>
<td>goblet cell</td>
<td>CL:0000160</td>
<td>skos:exactMatch</td>
<td>epithelial cell</td>
<td>epithelial cell</td>
<td>CL:0000066</td>
<td>skos:exactMatch</td>
<td>layer_3</td>
<td>colon-xenium-stanford</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">1</td>
<td>1079.01</td>
<td>2534.23</td>
<td>Tuft</td>
<td>tuft cell:intestinal</td>
<td>intestinal tuft cell</td>
<td>CL:0019032</td>
<td>skos:exactMatch</td>
<td>tuft cell</td>
<td>brush cell</td>
<td>CL:0002204</td>
<td>skos:exactMatch</td>
<td>epithelial cell</td>
<td>epithelial cell</td>
<td>CL:0000066</td>
<td>skos:exactMatch</td>
<td>layer_3</td>
<td>colon-xenium-stanford</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">2</td>
<td>1082.65</td>
<td>2554.09</td>
<td>TA1</td>
<td>transit amplifying cell</td>
<td>transit amplifying cell</td>
<td>CL:0009010</td>
<td>skos:exactMatch</td>
<td>enterocyte</td>
<td>enterocyte</td>
<td>CL:0000584</td>
<td>skos:exactMatch</td>
<td>epithelial cell</td>
<td>epithelial cell</td>
<td>CL:0000066</td>
<td>skos:exactMatch</td>
<td>layer_3</td>
<td>colon-xenium-stanford</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">3</td>
<td>1091.89</td>
<td>2547.38</td>
<td>Immature Goblet</td>
<td>goblet cell:immature</td>
<td>goblet cell:immature</td>
<td>CL:0000160</td>
<td>skos:narrowMatch</td>
<td>goblet cell</td>
<td>goblet cell</td>
<td>CL:0000160</td>
<td>skos:exactMatch</td>
<td>epithelial cell</td>
<td>epithelial cell</td>
<td>CL:0000066</td>
<td>skos:exactMatch</td>
<td>layer_3</td>
<td>colon-xenium-stanford</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">4</td>
<td>1253.46</td>
<td>2554.64</td>
<td>CD4+</td>
<td>t cell:cd4+ alpha-beta</td>
<td>CD4-positive, alpha-beta T cell</td>
<td>CL:0000624</td>
<td>skos:exactMatch</td>
<td>t cell</td>
<td>T cell</td>
<td>CL:0000084</td>
<td>skos:exactMatch</td>
<td>immune cell</td>
<td>leukocyte</td>
<td>CL:0000738</td>
<td>skos:exactMatch</td>
<td>layer_3</td>
<td>colon-xenium-stanford</td>
</tr>
</tbody>
</table>

</div>

``` python
# Print the total number of unique cell types per dataset. Compute separately for each cell type column (Level One Cell Type, Level Two Cell Type, Level Three Cell Type, Original Cell Type).
print("Total number of unique cell types per cell type annnotation level:")
unique_cell_types = {
    'Original Cell Type': df_all_nodes['Original Cell Type'].nunique(),
    'Level Three Cell Type': df_all_nodes['Level Three Cell Type'].nunique(),
    'Level Two Cell Type': df_all_nodes['Level Two Cell Type'].nunique(),
    'Level One Cell Type': df_all_nodes['Level One Cell Type'].nunique()
}
for cell_type, count in unique_cell_types.items():
    print(f"{cell_type}: {count}")
```

    Total number of unique cell types per cell type annnotation level:
    Original Cell Type: 61
    Level Three Cell Type: 56
    Level Two Cell Type: 21
    Level One Cell Type: 6

``` python
# Save the unique cell types containing "endothelial" in name per cell type column (Level One Cell Type, Level Two Cell Type, Level Three Cell Type, Original Cell Type) to a dictionary where the key is the level and the value is a list of unique cell types.
endothelial_cell_types = {
    'Original Cell Type': df_all_nodes[df_all_nodes['Original Cell Type'].str.contains("endothelial", case=False, na=False)]['Original Cell Type'].unique().tolist(),
    'Level Three Cell Type': df_all_nodes[df_all_nodes['Level Three Cell Type'].str.contains("endothelial", case=False, na=False)]['Level Three Cell Type'].unique().tolist(),
    'Level Two Cell Type': df_all_nodes[df_all_nodes['Level Two Cell Type'].str.contains("endothelial", case=False, na=False)]['Level Two Cell Type'].unique().tolist(),
    'Level One Cell Type': df_all_nodes[df_all_nodes['Level One Cell Type'].str.contains("endothelial", case=False, na=False)]['Level One Cell Type'].unique().tolist()
}

print("\nEndothelial cell types per cell type annotation level:")
for level, cell_types in endothelial_cell_types.items():
    print(f"\n{level}:")
    for cell in cell_types:
        print(f"  - {cell}")
```


    Endothelial cell types per cell type annotation level:

    Original Cell Type:
      - Endothelial
      - Lymphatic endothelial cells

    Level Three Cell Type:
      - endothelial cell
      - endothelial cell of lymphatic vessel

    Level Two Cell Type:
      - endothelial cell
      - endothelial cell of lymphatic vessel

    Level One Cell Type:
      - endothelial cell

``` python
type_field_list = ["Level Three Cell Type", "Level Two Cell Type", "Level One Cell Type"] # Skipping Original Cell Type as it is not a hierarchical level.

# Define the anchor cell type (type of endothelial cell) for each level in type_field_list based on available categories in the previous cell. The distance analysis at all three levels will be limited to the specified anchor cell type.
anchor_cell_type_dict = {
    'Level Three Cell Type': 'endothelial cell',
    'Level Two Cell Type': 'endothelial cell',
    'Level One Cell Type': 'endothelial cell'
}
```

## Process datasets to add region information to Nodes files.

``` python
# Create a dictionary to map skin regions to correct condition.
region_map = {dataset_dir_1:'xenium-stanford',
 dataset_dir_2:'cycif-sorgerlab', 
}

# Define the standard region sequence for plots
regions = ['xenium-stanford', 'cycif-sorgerlab']
```

``` python
df_all_nodes.head()
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&#10;    .dataframe tbody tr th {
        vertical-align: top;
    }
&#10;    .dataframe thead th {
        text-align: right;
    }
</style>

<table class="dataframe" data-quarto-postprocess="true" data-border="1">
<thead>
<tr style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">x</th>
<th data-quarto-table-cell-role="th">y</th>
<th data-quarto-table-cell-role="th">Original Cell Type</th>
<th data-quarto-table-cell-role="th">Level Three Cell Type</th>
<th data-quarto-table-cell-role="th">Level Three CL Label</th>
<th data-quarto-table-cell-role="th">Level Three CL ID</th>
<th data-quarto-table-cell-role="th">CL_Match/3</th>
<th data-quarto-table-cell-role="th">Level Two Cell Type</th>
<th data-quarto-table-cell-role="th">Level Two CL Label</th>
<th data-quarto-table-cell-role="th">Level Two CL ID</th>
<th data-quarto-table-cell-role="th">CL_Match/2</th>
<th data-quarto-table-cell-role="th">Level One Cell Type</th>
<th data-quarto-table-cell-role="th">Level One CL Label</th>
<th data-quarto-table-cell-role="th">Level One CL ID</th>
<th data-quarto-table-cell-role="th">CL_Match/1</th>
<th data-quarto-table-cell-role="th">Dataset</th>
<th data-quarto-table-cell-role="th">Tissue Type</th>
</tr>
</thead>
<tbody>
<tr>
<td data-quarto-table-cell-role="th">0</td>
<td>1077.96</td>
<td>2556.82</td>
<td>Immature Goblet</td>
<td>goblet cell:immature</td>
<td>goblet cell:immature</td>
<td>CL:0000160</td>
<td>skos:narrowMatch</td>
<td>goblet cell</td>
<td>goblet cell</td>
<td>CL:0000160</td>
<td>skos:exactMatch</td>
<td>epithelial cell</td>
<td>epithelial cell</td>
<td>CL:0000066</td>
<td>skos:exactMatch</td>
<td>layer_3</td>
<td>colon-xenium-stanford</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">1</td>
<td>1079.01</td>
<td>2534.23</td>
<td>Tuft</td>
<td>tuft cell:intestinal</td>
<td>intestinal tuft cell</td>
<td>CL:0019032</td>
<td>skos:exactMatch</td>
<td>tuft cell</td>
<td>brush cell</td>
<td>CL:0002204</td>
<td>skos:exactMatch</td>
<td>epithelial cell</td>
<td>epithelial cell</td>
<td>CL:0000066</td>
<td>skos:exactMatch</td>
<td>layer_3</td>
<td>colon-xenium-stanford</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">2</td>
<td>1082.65</td>
<td>2554.09</td>
<td>TA1</td>
<td>transit amplifying cell</td>
<td>transit amplifying cell</td>
<td>CL:0009010</td>
<td>skos:exactMatch</td>
<td>enterocyte</td>
<td>enterocyte</td>
<td>CL:0000584</td>
<td>skos:exactMatch</td>
<td>epithelial cell</td>
<td>epithelial cell</td>
<td>CL:0000066</td>
<td>skos:exactMatch</td>
<td>layer_3</td>
<td>colon-xenium-stanford</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">3</td>
<td>1091.89</td>
<td>2547.38</td>
<td>Immature Goblet</td>
<td>goblet cell:immature</td>
<td>goblet cell:immature</td>
<td>CL:0000160</td>
<td>skos:narrowMatch</td>
<td>goblet cell</td>
<td>goblet cell</td>
<td>CL:0000160</td>
<td>skos:exactMatch</td>
<td>epithelial cell</td>
<td>epithelial cell</td>
<td>CL:0000066</td>
<td>skos:exactMatch</td>
<td>layer_3</td>
<td>colon-xenium-stanford</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">4</td>
<td>1253.46</td>
<td>2554.64</td>
<td>CD4+</td>
<td>t cell:cd4+ alpha-beta</td>
<td>CD4-positive, alpha-beta T cell</td>
<td>CL:0000624</td>
<td>skos:exactMatch</td>
<td>t cell</td>
<td>T cell</td>
<td>CL:0000084</td>
<td>skos:exactMatch</td>
<td>immune cell</td>
<td>leukocyte</td>
<td>CL:0000738</td>
<td>skos:exactMatch</td>
<td>layer_3</td>
<td>colon-xenium-stanford</td>
</tr>
</tbody>
</table>

</div>

``` python
# Iterate through the df_all_data dataframe to create new column "Unique Region" based on the "Tissue Type" column.
# The "Unique Region" column is created by mapping the region names based on the full dataset name.
df_all_nodes['Unique Region'] = df_all_nodes['Tissue Type'].map(region_map)

# Check if the new columns are created correctly.
df_all_nodes[['Tissue Type', 'Unique Region']].head(5)
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&#10;    .dataframe tbody tr th {
        vertical-align: top;
    }
&#10;    .dataframe thead th {
        text-align: right;
    }
</style>

<table class="dataframe" data-quarto-postprocess="true" data-border="1">
<thead>
<tr style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Tissue Type</th>
<th data-quarto-table-cell-role="th">Unique Region</th>
</tr>
</thead>
<tbody>
<tr>
<td data-quarto-table-cell-role="th">0</td>
<td>colon-xenium-stanford</td>
<td>xenium-stanford</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">1</td>
<td>colon-xenium-stanford</td>
<td>xenium-stanford</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">2</td>
<td>colon-xenium-stanford</td>
<td>xenium-stanford</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">3</td>
<td>colon-xenium-stanford</td>
<td>xenium-stanford</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">4</td>
<td>colon-xenium-stanford</td>
<td>xenium-stanford</td>
</tr>
</tbody>
</table>

</div>

``` python
# Print all unique regions in the data.
print("\nUnique Regions in the data:")
print(df_all_nodes['Unique Region'].unique())

# Print the total number of unique regions.
print(f"Total number of unique regions: {df_all_nodes['Unique Region'].nunique()}")

# Print number of unique datasets per unique region.
print("\nNumber of unique datasets per unique region:")
for region in df_all_nodes['Unique Region'].unique():
    num_datasets = df_all_nodes[df_all_nodes['Unique Region'] == region]['Dataset'].nunique()
    print(f"{region}: {num_datasets}")
```


    Unique Regions in the data:
    ['xenium-stanford' 'cycif-sorgerlab']
    Total number of unique regions: 2

    Number of unique datasets per unique region:
    xenium-stanford: 29
    cycif-sorgerlab: 25

## Process datasets to add region information to Edges files.

``` python
df_all_edges.head(5)
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&#10;    .dataframe tbody tr th {
        vertical-align: top;
    }
&#10;    .dataframe thead th {
        text-align: right;
    }
</style>

<table class="dataframe" data-quarto-postprocess="true" data-border="1">
<thead>
<tr style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">cell_id</th>
<th data-quarto-table-cell-role="th">x1</th>
<th data-quarto-table-cell-role="th">y1</th>
<th data-quarto-table-cell-role="th">z1</th>
<th data-quarto-table-cell-role="th">x2</th>
<th data-quarto-table-cell-role="th">y2</th>
<th data-quarto-table-cell-role="th">z2</th>
<th data-quarto-table-cell-role="th">Distance</th>
<th data-quarto-table-cell-role="th">Dataset</th>
<th data-quarto-table-cell-role="th">Anchor Cell Type</th>
<th data-quarto-table-cell-role="th">Anchor Cell Type Level</th>
<th data-quarto-table-cell-role="th">Tissue Type</th>
</tr>
</thead>
<tbody>
<tr>
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>1077.96</td>
<td>2556.82</td>
<td>0</td>
<td>1056.03</td>
<td>2582.37</td>
<td>0</td>
<td>33.670869</td>
<td>layer_3</td>
<td>endothelial cell</td>
<td>Level Three Cell Type</td>
<td>colon-xenium-stanford</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">1</td>
<td>1</td>
<td>1079.01</td>
<td>2534.23</td>
<td>0</td>
<td>1126.32</td>
<td>2518.75</td>
<td>0</td>
<td>49.778173</td>
<td>layer_3</td>
<td>endothelial cell</td>
<td>Level Three Cell Type</td>
<td>colon-xenium-stanford</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">2</td>
<td>2</td>
<td>1082.65</td>
<td>2554.09</td>
<td>0</td>
<td>1056.03</td>
<td>2582.37</td>
<td>0</td>
<td>38.837904</td>
<td>layer_3</td>
<td>endothelial cell</td>
<td>Level Three Cell Type</td>
<td>colon-xenium-stanford</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">3</td>
<td>3</td>
<td>1091.89</td>
<td>2547.38</td>
<td>0</td>
<td>1126.32</td>
<td>2518.75</td>
<td>0</td>
<td>44.778363</td>
<td>layer_3</td>
<td>endothelial cell</td>
<td>Level Three Cell Type</td>
<td>colon-xenium-stanford</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">4</td>
<td>5</td>
<td>1104.66</td>
<td>2546.60</td>
<td>0</td>
<td>1126.32</td>
<td>2518.75</td>
<td>0</td>
<td>35.281413</td>
<td>layer_3</td>
<td>endothelial cell</td>
<td>Level Three Cell Type</td>
<td>colon-xenium-stanford</td>
</tr>
</tbody>
</table>

</div>

``` python
# Process the edge data to create new columns "Unique Region" based on the "Tissue Type" column, similar to how it was done for the node data.
df_all_edges['Unique Region'] = df_all_edges['Tissue Type'].map(region_map)

# Check if the new columns are created correctly.
df_all_edges[['Tissue Type', 'Unique Region']].head(5)
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&#10;    .dataframe tbody tr th {
        vertical-align: top;
    }
&#10;    .dataframe thead th {
        text-align: right;
    }
</style>

<table class="dataframe" data-quarto-postprocess="true" data-border="1">
<thead>
<tr style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Tissue Type</th>
<th data-quarto-table-cell-role="th">Unique Region</th>
</tr>
</thead>
<tbody>
<tr>
<td data-quarto-table-cell-role="th">0</td>
<td>colon-xenium-stanford</td>
<td>xenium-stanford</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">1</td>
<td>colon-xenium-stanford</td>
<td>xenium-stanford</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">2</td>
<td>colon-xenium-stanford</td>
<td>xenium-stanford</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">3</td>
<td>colon-xenium-stanford</td>
<td>xenium-stanford</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">4</td>
<td>colon-xenium-stanford</td>
<td>xenium-stanford</td>
</tr>
</tbody>
</table>

</div>

``` python
# Print all unique regions in the data.
print("\nUnique Regions in the data:")
print(df_all_edges['Unique Region'].unique())

# Print the total number of unique regions.
print(f"Total number of unique regions: {df_all_edges['Unique Region'].nunique()}")

# Print number of unique datasets per unique region.
print("\nNumber of unique datasets per unique region:")
for region in df_all_edges['Unique Region'].unique():
    num_datasets = df_all_edges[df_all_edges['Unique Region'] == region]['Dataset'].nunique()
    print(f"{region}: {num_datasets}")
```


    Unique Regions in the data:
    ['xenium-stanford' 'cycif-sorgerlab']
    Total number of unique regions: 2

    Number of unique datasets per unique region:
    xenium-stanford: 29
    cycif-sorgerlab: 25

``` python
df_all_edges_with_cell_types['Unique Region'] = df_all_edges_with_cell_types['Tissue Type'].map(region_map)

# Check if the new columns are created correctly.
df_all_edges_with_cell_types[['Tissue Type', 'Unique Region']].head(5)
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&#10;    .dataframe tbody tr th {
        vertical-align: top;
    }
&#10;    .dataframe thead th {
        text-align: right;
    }
</style>

<table class="dataframe" data-quarto-postprocess="true" data-border="1">
<thead>
<tr style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Tissue Type</th>
<th data-quarto-table-cell-role="th">Unique Region</th>
</tr>
</thead>
<tbody>
<tr>
<td data-quarto-table-cell-role="th">0</td>
<td>colon-xenium-stanford</td>
<td>xenium-stanford</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">1</td>
<td>colon-xenium-stanford</td>
<td>xenium-stanford</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">2</td>
<td>colon-xenium-stanford</td>
<td>xenium-stanford</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">3</td>
<td>colon-xenium-stanford</td>
<td>xenium-stanford</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">4</td>
<td>colon-xenium-stanford</td>
<td>xenium-stanford</td>
</tr>
</tbody>
</table>

</div>

``` python
df_all_nodes.head(1)
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&#10;    .dataframe tbody tr th {
        vertical-align: top;
    }
&#10;    .dataframe thead th {
        text-align: right;
    }
</style>

<table class="dataframe" data-quarto-postprocess="true" data-border="1">
<thead>
<tr style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">x</th>
<th data-quarto-table-cell-role="th">y</th>
<th data-quarto-table-cell-role="th">Original Cell Type</th>
<th data-quarto-table-cell-role="th">Level Three Cell Type</th>
<th data-quarto-table-cell-role="th">Level Three CL Label</th>
<th data-quarto-table-cell-role="th">Level Three CL ID</th>
<th data-quarto-table-cell-role="th">CL_Match/3</th>
<th data-quarto-table-cell-role="th">Level Two Cell Type</th>
<th data-quarto-table-cell-role="th">Level Two CL Label</th>
<th data-quarto-table-cell-role="th">Level Two CL ID</th>
<th data-quarto-table-cell-role="th">CL_Match/2</th>
<th data-quarto-table-cell-role="th">Level One Cell Type</th>
<th data-quarto-table-cell-role="th">Level One CL Label</th>
<th data-quarto-table-cell-role="th">Level One CL ID</th>
<th data-quarto-table-cell-role="th">CL_Match/1</th>
<th data-quarto-table-cell-role="th">Dataset</th>
<th data-quarto-table-cell-role="th">Tissue Type</th>
<th data-quarto-table-cell-role="th">Unique Region</th>
</tr>
</thead>
<tbody>
<tr>
<td data-quarto-table-cell-role="th">0</td>
<td>1077.96</td>
<td>2556.82</td>
<td>Immature Goblet</td>
<td>goblet cell:immature</td>
<td>goblet cell:immature</td>
<td>CL:0000160</td>
<td>skos:narrowMatch</td>
<td>goblet cell</td>
<td>goblet cell</td>
<td>CL:0000160</td>
<td>skos:exactMatch</td>
<td>epithelial cell</td>
<td>epithelial cell</td>
<td>CL:0000066</td>
<td>skos:exactMatch</td>
<td>layer_3</td>
<td>colon-xenium-stanford</td>
<td>xenium-stanford</td>
</tr>
</tbody>
</table>

</div>

``` python
df_all_edges.head(1)
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&#10;    .dataframe tbody tr th {
        vertical-align: top;
    }
&#10;    .dataframe thead th {
        text-align: right;
    }
</style>

<table class="dataframe" data-quarto-postprocess="true" data-border="1">
<thead>
<tr style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">cell_id</th>
<th data-quarto-table-cell-role="th">x1</th>
<th data-quarto-table-cell-role="th">y1</th>
<th data-quarto-table-cell-role="th">z1</th>
<th data-quarto-table-cell-role="th">x2</th>
<th data-quarto-table-cell-role="th">y2</th>
<th data-quarto-table-cell-role="th">z2</th>
<th data-quarto-table-cell-role="th">Distance</th>
<th data-quarto-table-cell-role="th">Dataset</th>
<th data-quarto-table-cell-role="th">Anchor Cell Type</th>
<th data-quarto-table-cell-role="th">Anchor Cell Type Level</th>
<th data-quarto-table-cell-role="th">Tissue Type</th>
<th data-quarto-table-cell-role="th">Unique Region</th>
</tr>
</thead>
<tbody>
<tr>
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>1077.96</td>
<td>2556.82</td>
<td>0</td>
<td>1056.03</td>
<td>2582.37</td>
<td>0</td>
<td>33.670869</td>
<td>layer_3</td>
<td>endothelial cell</td>
<td>Level Three Cell Type</td>
<td>colon-xenium-stanford</td>
<td>xenium-stanford</td>
</tr>
</tbody>
</table>

</div>

``` python
df_all_edges_with_cell_types.head(1)
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&#10;    .dataframe tbody tr th {
        vertical-align: top;
    }
&#10;    .dataframe thead th {
        text-align: right;
    }
</style>

<table class="dataframe" data-quarto-postprocess="true" data-border="1">
<thead>
<tr style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">cell_id</th>
<th data-quarto-table-cell-role="th">x1</th>
<th data-quarto-table-cell-role="th">y1</th>
<th data-quarto-table-cell-role="th">z1</th>
<th data-quarto-table-cell-role="th">x2</th>
<th data-quarto-table-cell-role="th">y2</th>
<th data-quarto-table-cell-role="th">z2</th>
<th data-quarto-table-cell-role="th">Distance</th>
<th data-quarto-table-cell-role="th">Dataset</th>
<th data-quarto-table-cell-role="th">Anchor Cell Type</th>
<th data-quarto-table-cell-role="th">Anchor Cell Type Level</th>
<th data-quarto-table-cell-role="th">Level Three Cell Type</th>
<th data-quarto-table-cell-role="th">Level Two Cell Type</th>
<th data-quarto-table-cell-role="th">Level One Cell Type</th>
<th data-quarto-table-cell-role="th">Tissue Type</th>
<th data-quarto-table-cell-role="th">Unique Region</th>
</tr>
</thead>
<tbody>
<tr>
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>1077.96</td>
<td>2556.82</td>
<td>0</td>
<td>1056.03</td>
<td>2582.37</td>
<td>0</td>
<td>33.670869</td>
<td>layer_3</td>
<td>endothelial cell</td>
<td>Level Three Cell Type</td>
<td>goblet cell:immature</td>
<td>goblet cell</td>
<td>epithelial cell</td>
<td>colon-xenium-stanford</td>
<td>xenium-stanford</td>
</tr>
</tbody>
</table>

</div>

## Node Analysis

``` python
# Plot number of cells per cell type in the same plot. Color by cell type and unique region. Output figure saved in existing `figures_output_dir`.
def plot_cells_per_celltype(df, type_field, output_dir):
    plt.figure(figsize=(20, 8))
    plt.rcParams["svg.fonttype"] = 'none'  # to store text as text, not as path
    sns.countplot(data=df, x=type_field, palette='Spectral', hue='Unique Region')
    plt.title(f'Number of Cells per {type_field} in `{dataset_dir}`')
    plt.xticks(rotation=90)
    plt.tight_layout()
    plt.savefig(os.path.join(output_dir, f'{dataset_dir}_cells_per_celltype_{type_field}.png'), dpi=300,
                bbox_inches='tight',
                pad_inches=0.5)
    plt.savefig(os.path.join(output_dir, f'{dataset_dir}_cells_per_celltype_{type_field}.svg'), dpi=300,
                bbox_inches='tight',
                pad_inches=0.5)
    plt.legend(title='Unique Region', bbox_to_anchor=(0.85, 1), loc='upper left')
    plt.xlabel(type_field)

    # For numbers on y-axis, do not use scientific notation.
    plt.ticklabel_format(style='plain', axis='y')
    # Set y-axis label
    plt.ylabel('Number of Cells')
    plt.grid(axis='y', linestyle='--', alpha=0.7)
    plt.tight_layout()
    # Show the plot
    plt.show()
    plt.close()
for type_field in type_field_list:
    plot_cells_per_celltype(df_all_nodes, type_field, os.path.join(basepath, figures_output_dir))
```

![](10_distance_analysis__colon-cycif-sorgerlab-colon-xenium-stanford_files/figure-commonmark/cell-23-output-1.png)

![](10_distance_analysis__colon-cycif-sorgerlab-colon-xenium-stanford_files/figure-commonmark/cell-23-output-2.png)

![](10_distance_analysis__colon-cycif-sorgerlab-colon-xenium-stanford_files/figure-commonmark/cell-23-output-3.png)

## Distance Analysis

``` python
# Get mean, median, minimum, maximum distance per unique region per anchor cell type.
df_distance_stats = df_all_edges_with_cell_types.groupby(['Unique Region', 'Anchor Cell Type', 'Anchor Cell Type Level']).agg(
    mean_distance=('Distance', 'mean'),
    median_distance=('Distance', 'median'),
    min_distance=('Distance', 'min'),
    max_distance=('Distance', 'max')
).reset_index()
# Print the first few rows of the distance statistics DataFrame.
df_distance_stats
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&#10;    .dataframe tbody tr th {
        vertical-align: top;
    }
&#10;    .dataframe thead th {
        text-align: right;
    }
</style>

<table class="dataframe" data-quarto-postprocess="true" data-border="1">
<thead>
<tr style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Unique Region</th>
<th data-quarto-table-cell-role="th">Anchor Cell Type</th>
<th data-quarto-table-cell-role="th">Anchor Cell Type Level</th>
<th data-quarto-table-cell-role="th">mean_distance</th>
<th data-quarto-table-cell-role="th">median_distance</th>
<th data-quarto-table-cell-role="th">min_distance</th>
<th data-quarto-table-cell-role="th">max_distance</th>
</tr>
</thead>
<tbody>
<tr>
<td data-quarto-table-cell-role="th">0</td>
<td>cycif-sorgerlab</td>
<td>endothelial cell</td>
<td>Level One Cell Type</td>
<td>50.997434</td>
<td>41.644288</td>
<td>3.812328</td>
<td>199.999898</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">1</td>
<td>cycif-sorgerlab</td>
<td>endothelial cell</td>
<td>Level Three Cell Type</td>
<td>50.997434</td>
<td>41.644288</td>
<td>3.812328</td>
<td>199.999898</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">2</td>
<td>cycif-sorgerlab</td>
<td>endothelial cell</td>
<td>Level Two Cell Type</td>
<td>50.997434</td>
<td>41.644288</td>
<td>3.812328</td>
<td>199.999898</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">3</td>
<td>xenium-stanford</td>
<td>endothelial cell</td>
<td>Level One Cell Type</td>
<td>27.849965</td>
<td>23.669005</td>
<td>0.657771</td>
<td>199.995802</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">4</td>
<td>xenium-stanford</td>
<td>endothelial cell</td>
<td>Level Three Cell Type</td>
<td>28.173444</td>
<td>23.966392</td>
<td>0.657771</td>
<td>199.995802</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">5</td>
<td>xenium-stanford</td>
<td>endothelial cell</td>
<td>Level Two Cell Type</td>
<td>28.173444</td>
<td>23.966392</td>
<td>0.657771</td>
<td>199.995802</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">6</td>
<td>xenium-stanford</td>
<td>endothelial cell of lymphatic vessel</td>
<td>Level Three Cell Type</td>
<td>110.829788</td>
<td>111.918301</td>
<td>1.774604</td>
<td>199.999893</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">7</td>
<td>xenium-stanford</td>
<td>endothelial cell of lymphatic vessel</td>
<td>Level Two Cell Type</td>
<td>110.829788</td>
<td>111.918301</td>
<td>1.774604</td>
<td>199.999893</td>
</tr>
</tbody>
</table>

</div>

### Level One Cell Type Analysis

``` python
# Get mean, median, minimum, maximum distance per cell type in all unique regions.
cell_type_level = 'Level One Cell Type'
df_all_edges_with_cell_type_level = df_all_edges_with_cell_types[(df_all_edges_with_cell_types['Anchor Cell Type Level'] == cell_type_level) & (df_all_edges_with_cell_types['Anchor Cell Type'] == anchor_cell_type_dict[cell_type_level])]

df_distance_stats_cell_type_level = df_all_edges_with_cell_type_level.groupby([cell_type_level, 'Unique Region']).agg(
    mean_distance=('Distance', 'mean'),
    median_distance=('Distance', 'median'),
    min_distance=('Distance', 'min'),
    max_distance=('Distance', 'max')
).reset_index()
df_distance_stats_cell_type_level
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&#10;    .dataframe tbody tr th {
        vertical-align: top;
    }
&#10;    .dataframe thead th {
        text-align: right;
    }
</style>

<table class="dataframe" data-quarto-postprocess="true" data-border="1">
<thead>
<tr style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Level One Cell Type</th>
<th data-quarto-table-cell-role="th">Unique Region</th>
<th data-quarto-table-cell-role="th">mean_distance</th>
<th data-quarto-table-cell-role="th">median_distance</th>
<th data-quarto-table-cell-role="th">min_distance</th>
<th data-quarto-table-cell-role="th">max_distance</th>
</tr>
</thead>
<tbody>
<tr>
<td data-quarto-table-cell-role="th">0</td>
<td>epithelial cell</td>
<td>cycif-sorgerlab</td>
<td>59.237837</td>
<td>50.521866</td>
<td>4.447199</td>
<td>199.999898</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">1</td>
<td>epithelial cell</td>
<td>xenium-stanford</td>
<td>33.029849</td>
<td>29.294328</td>
<td>0.657771</td>
<td>199.988725</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">2</td>
<td>immune cell</td>
<td>cycif-sorgerlab</td>
<td>43.793795</td>
<td>34.054817</td>
<td>3.812328</td>
<td>199.996448</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">3</td>
<td>immune cell</td>
<td>xenium-stanford</td>
<td>21.876177</td>
<td>17.939406</td>
<td>1.545798</td>
<td>199.762275</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">4</td>
<td>mesenchymal cell</td>
<td>cycif-sorgerlab</td>
<td>48.551081</td>
<td>39.884627</td>
<td>3.859785</td>
<td>199.995059</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">5</td>
<td>mesenchymal cell</td>
<td>xenium-stanford</td>
<td>20.657124</td>
<td>16.590299</td>
<td>1.097860</td>
<td>197.299831</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">6</td>
<td>neural cell</td>
<td>xenium-stanford</td>
<td>21.862930</td>
<td>17.446054</td>
<td>1.767815</td>
<td>198.410186</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">7</td>
<td>unknown cell</td>
<td>cycif-sorgerlab</td>
<td>45.301241</td>
<td>32.613405</td>
<td>4.331525</td>
<td>199.996828</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">8</td>
<td>unknown cell</td>
<td>xenium-stanford</td>
<td>25.550199</td>
<td>19.528765</td>
<td>1.746407</td>
<td>199.995802</td>
</tr>
</tbody>
</table>

</div>

``` python
# Get top five and bottom five cell types with respect to mean distance in each unique region separately.
def get_top_bottom_cell_types_by_mean(df, cell_type_level, unique_region, top_n=5):
    # Filter the DataFrame for the specified unique region and cell type level
    df_filtered = df[df['Unique Region'] == unique_region]

    # Group by the specified cell type level and calculate mean distance
    df_grouped = df_filtered.groupby(cell_type_level).agg(mean_distance=('Distance', 'mean')).reset_index()
    
    # Sort by mean distance to get top and bottom cell types
    df_sorted = df_grouped.sort_values(by='mean_distance', ascending=False)
    
    # Get top N and bottom N cell types
    top_cell_types = df_sorted.head(top_n)
    bottom_cell_types = df_sorted.tail(top_n)
    
    return top_cell_types, bottom_cell_types

# Get top and bottom cell types for each unique region in the dataset.
unique_regions = df_all_edges_with_cell_type_level['Unique Region'].unique()
for region in unique_regions:
    top_bottom = get_top_bottom_cell_types_by_mean(df_all_edges_with_cell_type_level, cell_type_level, region)
    print(f"\nTop 5 cell types in {region}:")
    print(top_bottom[0])
    print(f"\nBottom 5 cell types in {region}:")
    print(top_bottom[1])
```


    Top 5 cell types in xenium-stanford:
      Level One Cell Type  mean_distance
    0     epithelial cell      33.029849
    4        unknown cell      25.550199
    1         immune cell      21.876177
    3         neural cell      21.862930
    2    mesenchymal cell      20.657124

    Bottom 5 cell types in xenium-stanford:
      Level One Cell Type  mean_distance
    0     epithelial cell      33.029849
    4        unknown cell      25.550199
    1         immune cell      21.876177
    3         neural cell      21.862930
    2    mesenchymal cell      20.657124

    Top 5 cell types in cycif-sorgerlab:
      Level One Cell Type  mean_distance
    0     epithelial cell      59.237837
    2    mesenchymal cell      48.551081
    3        unknown cell      45.301241
    1         immune cell      43.793795

    Bottom 5 cell types in cycif-sorgerlab:
      Level One Cell Type  mean_distance
    0     epithelial cell      59.237837
    2    mesenchymal cell      48.551081
    3        unknown cell      45.301241
    1         immune cell      43.793795

``` python
# Get top five and bottom five cell types with respect to median distance in each unique region separately.
def get_top_bottom_cell_types_by_median(df, cell_type_level, unique_region, top_n=5):
    # Filter the DataFrame for the specified unique region and cell type level
    df_filtered = df[df['Unique Region'] == unique_region]

    # Group by the specified cell type level and calculate median distance
    df_grouped = df_filtered.groupby(cell_type_level).agg(median_distance=('Distance', 'median')).reset_index()

    # Sort by median distance to get top and bottom cell types
    df_sorted = df_grouped.sort_values(by='median_distance', ascending=False)

    # Get top N and bottom N cell types
    top_cell_types = df_sorted.head(top_n)
    bottom_cell_types = df_sorted.tail(top_n)
    
    return top_cell_types, bottom_cell_types

# Get top and bottom cell types for each unique region in the dataset.
unique_regions = df_all_edges_with_cell_type_level['Unique Region'].unique()
for region in unique_regions:
    top_bottom = get_top_bottom_cell_types_by_median(df_all_edges_with_cell_type_level, cell_type_level, region)
    print(f"\nTop 5 cell types in {region}:")
    print(top_bottom[0])
    print(f"\nBottom 5 cell types in {region}:")
    print(top_bottom[1])
```


    Top 5 cell types in xenium-stanford:
      Level One Cell Type  median_distance
    0     epithelial cell        29.294328
    4        unknown cell        19.528765
    1         immune cell        17.939406
    3         neural cell        17.446054
    2    mesenchymal cell        16.590299

    Bottom 5 cell types in xenium-stanford:
      Level One Cell Type  median_distance
    0     epithelial cell        29.294328
    4        unknown cell        19.528765
    1         immune cell        17.939406
    3         neural cell        17.446054
    2    mesenchymal cell        16.590299

    Top 5 cell types in cycif-sorgerlab:
      Level One Cell Type  median_distance
    0     epithelial cell        50.521866
    2    mesenchymal cell        39.884627
    1         immune cell        34.054817
    3        unknown cell        32.613405

    Bottom 5 cell types in cycif-sorgerlab:
      Level One Cell Type  median_distance
    0     epithelial cell        50.521866
    2    mesenchymal cell        39.884627
    1         immune cell        34.054817
    3        unknown cell        32.613405

``` python
# Calculate regional variability
def calculate_regional_variability(df_all_edges_with_cell_type_level, cell_type_level):
    """    Calculate regional variability for distances in the given DataFrame.
    """
    regional_variability = df_all_edges_with_cell_type_level.groupby('Unique Region')['Distance'].agg([
        ('mean', 'mean'),
        ('std', 'std')
    ]).round(2)

    # Add CV as percentage
    regional_variability['CV (%)'] = (regional_variability['std'] / regional_variability['mean'] * 100).round(1)

    print("\nRegional Variability Analysis:")
    print("Mean: Average distance in each region")
    print("Std: Standard deviation of distances")
    print("CV: Coefficient of Variation (std/mean * 100%)")
    print(regional_variability)

    # Calculate variability for each cell type
    cell_type_variability = df_all_edges_with_cell_type_level.groupby(cell_type_level)['Distance'].agg([
        ('mean', 'mean'),
        ('std', 'std')
    ]).round(2)

    # Add CV as percentage
    cell_type_variability['CV (%)'] = (cell_type_variability['std'] / cell_type_variability['mean'] * 100).round(1)

    print("\nCell Type Variability Analysis (sorted by CV):")
    print(cell_type_variability.sort_values('CV (%)', ascending=False))

calculate_regional_variability(df_all_edges_with_cell_type_level, cell_type_level)
```


    Regional Variability Analysis:
    Mean: Average distance in each region
    Std: Standard deviation of distances
    CV: Coefficient of Variation (std/mean * 100%)
                      mean    std  CV (%)
    Unique Region                        
    cycif-sorgerlab  51.00  35.96    70.5
    xenium-stanford  27.85  19.03    68.3

    Cell Type Variability Analysis (sorted by CV):
                          mean    std  CV (%)
    Level One Cell Type                      
    unknown cell         42.86  37.05    86.4
    mesenchymal cell     41.49  33.21    80.0
    immune cell          41.41  32.80    79.2
    neural cell          21.86  16.10    73.7
    epithelial cell      53.40  35.30    66.1

``` python
# Generate Violin Plot
def plot_violin_cells_per_celltype(df_all_edges_with_cell_type_level, cell_type_level, output_dir, density_norm='area'):
    sns.set_style("whitegrid")
    sns.set_context("notebook", rc={"grid.linewidth": 2})
    plt.figure(figsize=(10, 6))
    plt.rcParams["svg.fonttype"] = 'none'  # to store text as text, not as path

    sns.violinplot(data=df_all_edges_with_cell_type_level, x=cell_type_level, y="Distance", density_norm=density_norm, common_norm=True, cut=0, inner="box", split=False, palette='Spectral', alpha=.9)

    sns.set_theme(style="whitegrid")
    sns.set_context("paper")


    font_size = 10
    plt.legend(fontsize=font_size)

    plt.title(f'Violin Plot of distances by {cell_type_level} (Density Normalization: {density_norm})', fontsize=font_size)

    plt.xlabel(f'{cell_type_level}', fontsize=font_size)
    plt.ylabel('Distance (\u03bcm)', fontsize=font_size)

    # Increase font size for all text in the figure
    plt.xticks(fontsize=font_size)
    plt.xticks(rotation=90)
    plt.yticks(fontsize=font_size)

    plt.tight_layout()

    plt.savefig(os.path.join(output_dir, f'{dataset_dir}_violin_cells_per_celltype_{cell_type_level}.png'), dpi=300,
                bbox_inches='tight',
                pad_inches=0.5)
    plt.savefig(os.path.join(output_dir, f'{dataset_dir}_violin_cells_per_celltype_{cell_type_level}.svg'), dpi=300,
                bbox_inches='tight',
                pad_inches=0.5)
    plt.show()

plot_violin_cells_per_celltype(df_all_edges_with_cell_type_level, cell_type_level, os.path.join(basepath, figures_output_dir), density_norm='area')
```

![](10_distance_analysis__colon-cycif-sorgerlab-colon-xenium-stanford_files/figure-commonmark/cell-29-output-1.png)

``` python
# Boxplots of distribution of distances by cell type and region.
def plot_distance_distribution_boxplots_by_region(df_all_edges_with_cell_type_level, cell_type_level, output_dir):
    plt.figure(figsize=(16, 8))
    plt.rcParams["svg.fonttype"] = 'none'  # to store text as text, not as path
    # Create categorical type with only the regions that exist in the data
    available_regions = [r for r in regions if r in df_all_edges_with_cell_type_level['Unique Region'].unique()]
    df_all_edges_with_cell_type_level['Unique Region'] = pd.Categorical(
        df_all_edges_with_cell_type_level['Unique Region'],
        categories=available_regions,
        ordered=True
    )

    # Make box plot.
    sns.boxplot(data=df_all_edges_with_cell_type_level, x=cell_type_level, y='Distance', hue='Unique Region', showfliers=False, palette='Spectral') # viridis or Spectral palette for better color distinction
    font_size = 10
    plt.xticks(rotation=90, ha='right', fontsize=font_size)
    plt.yticks(fontsize=font_size)
    plt.title(f'Distribution of distances by {cell_type_level} and region', fontsize=font_size)
    plt.xlabel(f'{cell_type_level}', fontsize=font_size)
    plt.ylabel('Distance (\u03bcm)', fontsize=font_size)
    plt.legend(bbox_to_anchor=(1, 1), loc='upper left')
    plt.tight_layout()

    plt.savefig(os.path.join(output_dir, f'{dataset_dir}_distance_distribution_boxplots_by_region_{cell_type_level}.png'), dpi=300,
                    bbox_inches='tight',
                    pad_inches=0.5)
    plt.savefig(os.path.join(output_dir, f'{dataset_dir}_distance_distribution_boxplots_by_region_{cell_type_level}.svg'), dpi=300,
                    bbox_inches='tight',
                    pad_inches=0.5)
    plt.show()

plot_distance_distribution_boxplots_by_region(df_all_edges_with_cell_type_level, cell_type_level, os.path.join(basepath, figures_output_dir))
```

![](10_distance_analysis__colon-cycif-sorgerlab-colon-xenium-stanford_files/figure-commonmark/cell-30-output-1.png)

``` python
# Boxplots of distribution of distances by cell type and region.
def plot_distance_distribution_heatmap(df_all_edges_with_cell_type_level, cell_type_level, output_dir):
    pivot_data = df_all_edges_with_cell_type_level.pivot_table(
    values='Distance',
    index=cell_type_level,
    columns='Unique Region',
    aggfunc='median'
    )

    plt.figure(figsize=(15, 10))
    plt.rcParams["svg.fonttype"] = 'none'  # to store text as text, not as path
    sns.heatmap(pivot_data, annot=True, fmt='.1f', cmap='Spectral')
    plt.title(f'Heatmap of median distances by {cell_type_level}', fontsize=12)

    font_size = 10
    plt.xticks(rotation=90, ha='right', fontsize=font_size)
    plt.yticks(fontsize=font_size)

    plt.xlabel('Unique Region', fontsize=font_size)
    plt.ylabel(f'{cell_type_level}', fontsize=font_size)
    
    plt.tight_layout()

    plt.savefig(os.path.join(output_dir, f'{dataset_dir}_distance_distribution_heatmap_{cell_type_level}.png'), dpi=300,
                    bbox_inches='tight',
                    pad_inches=0.5)
    plt.savefig(os.path.join(output_dir, f'{dataset_dir}_distance_distribution_heatmap_{cell_type_level}.svg'), dpi=300,
                    bbox_inches='tight',
                    pad_inches=0.5)
    plt.show()

plot_distance_distribution_heatmap(df_all_edges_with_cell_type_level, cell_type_level, os.path.join(basepath, figures_output_dir))
```

![](10_distance_analysis__colon-cycif-sorgerlab-colon-xenium-stanford_files/figure-commonmark/cell-31-output-1.png)

``` python
# Generate Violin Plot per unique region in both small intestine and large intestine. Create for all 8 regions as 8 subplots.
def plot_violin_plots_all_regions(df_all_edges_with_cell_type_level, cell_type_level, output_dir, density_norm="area"):
    sns.set_style("whitegrid")
    sns.set_context("notebook", rc={"grid.linewidth": 1})
    plt.rcParams["svg.fonttype"] = 'none'  # to store text as text, not as path
    font_size = 10
    fig, axs = plt.subplots(2, 1, figsize=(10, 15)) # Adjusted figsize for horizontal layout
    fig.suptitle(f'Distance distribution per {cell_type_level} in `{dataset_dir}` (density normalization = {density_norm})', fontsize=font_size, y=1)

    # Keep the sequence of Cell Types consistent across plots.
    cell_types = sorted(df_all_edges_with_cell_type_level[cell_type_level].unique())

    # Create a color palette based on the number of unique classes
    color_palette = sns.color_palette("Spectral", n_colors=len(cell_types))

    # Create a dictionary mapping class to color
    class_color_dict = dict(zip(cell_types, color_palette))

    for i, region in enumerate(regions):
        data_reg = df_all_edges_with_cell_type_level[df_all_edges_with_cell_type_level['Unique Region'] == region]
        sns.violinplot(data=data_reg, x=cell_type_level, y="Distance", density_norm=density_norm, common_norm=True, cut=0, inner="box", split=False, palette=class_color_dict, alpha=.9, ax=axs[i], hue=cell_type_level, legend=False, order=cell_types, fill=True)
        axs[i].set_title(region, fontsize=font_size)
        axs[i].set_xlabel('', fontsize=font_size)
        axs[i].set_ylabel('Distance (\u03bcm)', fontsize=font_size)
        # axs[i].tick_params(axis='x', labelrotation=90, labelsize=font_size)
        # only show xtick labels for the last subplot
        if i < len(regions) - 1:
            axs[i].set_xticklabels([])
        else:
            axs[i].set_xticklabels(cell_types, fontsize=font_size, rotation=90, ha='right')
        # axs[i].set_ylim(0, data_reg['Distance'].max() * 1.1)  # Set y-limits to be consistent across all plots
        axs[i].tick_params(axis='both', labelsize=font_size)

    # Use fig.text for precise label positioning
    fig.figure.text(0.5, -0.02, f'{cell_type_level}', ha='center', va='bottom', fontsize=font_size)

    plt.tight_layout()

    plt.savefig(os.path.join(output_dir, f'{dataset_dir}_violin_plots_all_regions_{cell_type_level}.png'), dpi=300,
                    bbox_inches='tight',
                    pad_inches=0.5)
    plt.savefig(os.path.join(output_dir, f'{dataset_dir}_violin_plots_all_regions_{cell_type_level}.svg'), dpi=300,
                    bbox_inches='tight',
                    pad_inches=0.5)
    
    plt.show()

plot_violin_plots_all_regions(df_all_edges_with_cell_type_level, cell_type_level, os.path.join(basepath, figures_output_dir), density_norm="count") # density_norm="count" or "area" can be used based on preference.
```

![](10_distance_analysis__colon-cycif-sorgerlab-colon-xenium-stanford_files/figure-commonmark/cell-32-output-1.png)

``` python
# Generate Split Violin Plot
def plot_violin_cells_per_celltype_split_by_condition(df_all_edges_with_cell_type_level, cell_type_level, output_dir, density_norm="area"):
    sns.set_style("whitegrid")
    sns.set_context("notebook", rc={"grid.linewidth": 2})
    plt.figure(figsize=(15, 10))
    plt.rcParams["svg.fonttype"] = 'none'  # to store text as text, not as path

    sns.violinplot(data=df_all_edges_with_cell_type_level, x=cell_type_level, y="Distance", hue="Unique Region", density_norm=density_norm, common_norm=True, cut=0, inner="box", split=True, palette='Spectral', alpha=.9, hue_order=regions)

    sns.set_theme(style="whitegrid")
    sns.set_context("paper")


    font_size = 10
    plt.legend(fontsize=font_size, loc='upper right', bbox_to_anchor=(1.15, 1))

    plt.title(f'Split violin plot of distances by {cell_type_level} (Density Normalization: {density_norm})', fontsize=font_size)

    plt.xlabel('Cell Type', fontsize=font_size)
    plt.ylabel('Distance (\u03bcm)', fontsize=font_size)

    # Increase font size for all text in the figure
    plt.xticks(fontsize=font_size)
    plt.xticks(rotation=90)
    plt.yticks(fontsize=font_size)

    plt.tight_layout()

    plt.savefig(os.path.join(output_dir, f'{dataset_dir}_plot_violin_cells_per_celltype_split_by_condition_{cell_type_level}.png'), dpi=300,
                bbox_inches='tight',
                pad_inches=0.5)
    plt.savefig(os.path.join(output_dir, f'{dataset_dir}_plot_violin_cells_per_celltype_split_by_condition_{cell_type_level}.svg'), dpi=300,
                bbox_inches='tight',
                pad_inches=0.5)
    plt.show()

plot_violin_cells_per_celltype_split_by_condition(df_all_edges_with_cell_type_level, cell_type_level, os.path.join(basepath, figures_output_dir), density_norm="count") # density_norm="count" or "area" can be used based on preference.
```

![](10_distance_analysis__colon-cycif-sorgerlab-colon-xenium-stanford_files/figure-commonmark/cell-33-output-1.png)

### Level Two Cell Type Analysis

``` python
# Get mean, median, minimum, maximum distance per cell type in all unique regions.
cell_type_level = 'Level Two Cell Type'
df_all_edges_with_cell_type_level = df_all_edges_with_cell_types[(df_all_edges_with_cell_types['Anchor Cell Type Level'] == cell_type_level) & (df_all_edges_with_cell_types['Anchor Cell Type'] == anchor_cell_type_dict[cell_type_level])]

df_distance_stats_cell_type_level = df_all_edges_with_cell_type_level.groupby([cell_type_level, 'Unique Region']).agg(
    mean_distance=('Distance', 'mean'),
    median_distance=('Distance', 'median'),
    min_distance=('Distance', 'min'),
    max_distance=('Distance', 'max')
).reset_index()
df_distance_stats_cell_type_level
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&#10;    .dataframe tbody tr th {
        vertical-align: top;
    }
&#10;    .dataframe thead th {
        text-align: right;
    }
</style>

<table class="dataframe" data-quarto-postprocess="true" data-border="1">
<thead>
<tr style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Level Two Cell Type</th>
<th data-quarto-table-cell-role="th">Unique Region</th>
<th data-quarto-table-cell-role="th">mean_distance</th>
<th data-quarto-table-cell-role="th">median_distance</th>
<th data-quarto-table-cell-role="th">min_distance</th>
<th data-quarto-table-cell-role="th">max_distance</th>
</tr>
</thead>
<tbody>
<tr>
<td data-quarto-table-cell-role="th">0</td>
<td>abnormal cell</td>
<td>cycif-sorgerlab</td>
<td>59.237837</td>
<td>50.521866</td>
<td>4.447199</td>
<td>199.999898</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">1</td>
<td>adipocyte</td>
<td>xenium-stanford</td>
<td>19.307335</td>
<td>15.506267</td>
<td>1.886588</td>
<td>179.829816</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">2</td>
<td>b cell</td>
<td>cycif-sorgerlab</td>
<td>44.742812</td>
<td>36.696395</td>
<td>3.812328</td>
<td>199.963430</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">3</td>
<td>b cell</td>
<td>xenium-stanford</td>
<td>19.868268</td>
<td>16.177394</td>
<td>1.545798</td>
<td>193.686073</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">4</td>
<td>dendritic cell</td>
<td>xenium-stanford</td>
<td>19.604743</td>
<td>16.317067</td>
<td>3.127862</td>
<td>82.356448</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">5</td>
<td>endocrine cell</td>
<td>xenium-stanford</td>
<td>28.989088</td>
<td>25.386019</td>
<td>1.870109</td>
<td>187.875767</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">6</td>
<td>endothelial cell of lymphatic vessel</td>
<td>xenium-stanford</td>
<td>20.220957</td>
<td>16.182602</td>
<td>1.837223</td>
<td>191.459774</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">7</td>
<td>enterocyte</td>
<td>xenium-stanford</td>
<td>35.016424</td>
<td>30.665961</td>
<td>1.416608</td>
<td>199.988725</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">8</td>
<td>fibroblast</td>
<td>cycif-sorgerlab</td>
<td>48.551081</td>
<td>39.884627</td>
<td>3.859785</td>
<td>199.995059</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">9</td>
<td>fibroblast</td>
<td>xenium-stanford</td>
<td>20.925389</td>
<td>16.923950</td>
<td>1.097860</td>
<td>197.299831</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">10</td>
<td>goblet cell</td>
<td>xenium-stanford</td>
<td>32.837030</td>
<td>29.215176</td>
<td>0.657771</td>
<td>199.932057</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">11</td>
<td>lymphoid cell</td>
<td>xenium-stanford</td>
<td>18.157623</td>
<td>17.780635</td>
<td>3.743766</td>
<td>38.542071</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">12</td>
<td>macrophage</td>
<td>cycif-sorgerlab</td>
<td>43.943644</td>
<td>33.602981</td>
<td>4.405694</td>
<td>199.996448</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">13</td>
<td>macrophage</td>
<td>xenium-stanford</td>
<td>17.955820</td>
<td>14.656862</td>
<td>1.547417</td>
<td>195.141153</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">14</td>
<td>mast cell</td>
<td>xenium-stanford</td>
<td>18.454766</td>
<td>15.402588</td>
<td>2.088500</td>
<td>176.025592</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">15</td>
<td>neuroglial cell</td>
<td>xenium-stanford</td>
<td>22.059399</td>
<td>17.544022</td>
<td>1.767815</td>
<td>198.410186</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">16</td>
<td>neuron</td>
<td>xenium-stanford</td>
<td>22.678683</td>
<td>18.777829</td>
<td>2.719914</td>
<td>159.601136</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">17</td>
<td>pericyte</td>
<td>xenium-stanford</td>
<td>21.258422</td>
<td>16.283206</td>
<td>1.592156</td>
<td>154.814276</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">18</td>
<td>stem cell</td>
<td>xenium-stanford</td>
<td>31.434218</td>
<td>28.909495</td>
<td>1.385274</td>
<td>199.354161</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">19</td>
<td>t cell</td>
<td>cycif-sorgerlab</td>
<td>43.606482</td>
<td>33.735886</td>
<td>4.162606</td>
<td>199.994514</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">20</td>
<td>t cell</td>
<td>xenium-stanford</td>
<td>19.999632</td>
<td>16.951968</td>
<td>1.759058</td>
<td>197.728143</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">21</td>
<td>transit amplifying cell</td>
<td>xenium-stanford</td>
<td>29.750915</td>
<td>25.985201</td>
<td>1.732760</td>
<td>199.762275</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">22</td>
<td>tuft cell</td>
<td>xenium-stanford</td>
<td>31.969551</td>
<td>29.702991</td>
<td>2.702540</td>
<td>148.896183</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">23</td>
<td>unknown cell</td>
<td>cycif-sorgerlab</td>
<td>45.301241</td>
<td>32.613405</td>
<td>4.331525</td>
<td>199.996828</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">24</td>
<td>unknown cell</td>
<td>xenium-stanford</td>
<td>26.071766</td>
<td>19.994800</td>
<td>1.746407</td>
<td>199.995802</td>
</tr>
</tbody>
</table>

</div>

``` python
# Get top and bottom cell types for each unique region in the dataset.
unique_regions = df_all_edges_with_cell_type_level['Unique Region'].unique()
for region in unique_regions:
    top_bottom = get_top_bottom_cell_types_by_mean(df_all_edges_with_cell_type_level, cell_type_level, region)
    print(f"\nTop 5 cell types in {region}:")
    print(top_bottom[0])
    print(f"\nBottom 5 cell types in {region}:")
    print(top_bottom[1])
```


    Top 5 cell types in xenium-stanford:
            Level Two Cell Type  mean_distance
    5                enterocyte      35.016424
    7               goblet cell      32.837030
    17                tuft cell      31.969551
    14                stem cell      31.434218
    16  transit amplifying cell      29.750915

    Bottom 5 cell types in xenium-stanford:
       Level Two Cell Type  mean_distance
    2       dendritic cell      19.604743
    0            adipocyte      19.307335
    10           mast cell      18.454766
    8        lymphoid cell      18.157623
    9           macrophage      17.955820

    Top 5 cell types in cycif-sorgerlab:
      Level Two Cell Type  mean_distance
    0       abnormal cell      59.237837
    2          fibroblast      48.551081
    5        unknown cell      45.301241
    1              b cell      44.742812
    3          macrophage      43.943644

    Bottom 5 cell types in cycif-sorgerlab:
      Level Two Cell Type  mean_distance
    2          fibroblast      48.551081
    5        unknown cell      45.301241
    1              b cell      44.742812
    3          macrophage      43.943644
    4              t cell      43.606482

``` python
# Get top and bottom cell types for each unique region in the dataset.
unique_regions = df_all_edges_with_cell_type_level['Unique Region'].unique()
for region in unique_regions:
    top_bottom = get_top_bottom_cell_types_by_median(df_all_edges_with_cell_type_level, cell_type_level, region)
    print(f"\nTop 5 cell types in {region}:")
    print(top_bottom[0])
    print(f"\nBottom 5 cell types in {region}:")
    print(top_bottom[1])
```


    Top 5 cell types in xenium-stanford:
            Level Two Cell Type  median_distance
    5                enterocyte        30.665961
    17                tuft cell        29.702991
    7               goblet cell        29.215176
    14                stem cell        28.909495
    16  transit amplifying cell        25.985201

    Bottom 5 cell types in xenium-stanford:
                         Level Two Cell Type  median_distance
    4   endothelial cell of lymphatic vessel        16.182602
    1                                 b cell        16.177394
    0                              adipocyte        15.506267
    10                             mast cell        15.402588
    9                             macrophage        14.656862

    Top 5 cell types in cycif-sorgerlab:
      Level Two Cell Type  median_distance
    0       abnormal cell        50.521866
    2          fibroblast        39.884627
    1              b cell        36.696395
    4              t cell        33.735886
    3          macrophage        33.602981

    Bottom 5 cell types in cycif-sorgerlab:
      Level Two Cell Type  median_distance
    2          fibroblast        39.884627
    1              b cell        36.696395
    4              t cell        33.735886
    3          macrophage        33.602981
    5        unknown cell        32.613405

``` python
calculate_regional_variability(df_all_edges_with_cell_type_level, cell_type_level)
```


    Regional Variability Analysis:
    Mean: Average distance in each region
    Std: Standard deviation of distances
    CV: Coefficient of Variation (std/mean * 100%)
                      mean    std  CV (%)
    Unique Region                        
    cycif-sorgerlab  51.00  35.96    70.5
    xenium-stanford  28.17  19.20    68.2

    Cell Type Variability Analysis (sorted by CV):
                                           mean    std  CV (%)
    Level Two Cell Type                                       
    unknown cell                          42.93  37.03    86.3
    macrophage                            41.74  33.88    81.2
    t cell                                42.22  33.30    78.9
    fibroblast                            42.72  33.53    78.5
    pericyte                              21.26  16.63    78.2
    endothelial cell of lymphatic vessel  20.22  15.35    75.9
    neuroglial cell                       22.06  16.31    73.9
    b cell                                41.76  30.62    73.3
    adipocyte                             19.31  14.10    73.0
    neuron                                22.68  15.63    68.9
    mast cell                             18.45  12.51    67.8
    dendritic cell                        19.60  13.26    67.7
    transit amplifying cell               29.75  19.42    65.3
    enterocyte                            35.02  21.68    61.9
    abnormal cell                         59.24  36.59    61.8
    endocrine cell                        28.99  17.56    60.6
    goblet cell                           32.84  19.25    58.6
    stem cell                             31.43  16.46    52.4
    lymphoid cell                         18.16   9.48    52.2
    tuft cell                             31.97  16.41    51.3

``` python
plot_violin_cells_per_celltype(df_all_edges_with_cell_type_level, cell_type_level, os.path.join(basepath, figures_output_dir), density_norm='area')
```

![](10_distance_analysis__colon-cycif-sorgerlab-colon-xenium-stanford_files/figure-commonmark/cell-38-output-1.png)

``` python
plot_distance_distribution_boxplots_by_region(df_all_edges_with_cell_type_level, cell_type_level, os.path.join(basepath, figures_output_dir))
```

![](10_distance_analysis__colon-cycif-sorgerlab-colon-xenium-stanford_files/figure-commonmark/cell-39-output-1.png)

``` python
plot_distance_distribution_heatmap(df_all_edges_with_cell_type_level, cell_type_level, os.path.join(basepath, figures_output_dir))
```

![](10_distance_analysis__colon-cycif-sorgerlab-colon-xenium-stanford_files/figure-commonmark/cell-40-output-1.png)

``` python
plot_violin_plots_all_regions(df_all_edges_with_cell_type_level, cell_type_level, os.path.join(basepath, figures_output_dir), density_norm="count") # Or, density_norm="count" or "area" based on preference.
```

![](10_distance_analysis__colon-cycif-sorgerlab-colon-xenium-stanford_files/figure-commonmark/cell-41-output-1.png)

``` python
plot_violin_cells_per_celltype_split_by_condition(df_all_edges_with_cell_type_level, cell_type_level, os.path.join(basepath, figures_output_dir), density_norm="count") # density_norm="count" or "area" can be used based on preference.
```

![](10_distance_analysis__colon-cycif-sorgerlab-colon-xenium-stanford_files/figure-commonmark/cell-42-output-1.png)

### Level Three Cell Type Analysis

``` python
# Get mean, median, minimum, maximum distance per cell type in all unique regions.
cell_type_level = 'Level Three Cell Type'
df_all_edges_with_cell_type_level = df_all_edges_with_cell_types[(df_all_edges_with_cell_types['Anchor Cell Type Level'] == cell_type_level) & (df_all_edges_with_cell_types['Anchor Cell Type'] == anchor_cell_type_dict[cell_type_level])]

df_distance_stats_cell_type_level = df_all_edges_with_cell_type_level.groupby([cell_type_level, 'Unique Region']).agg(
    mean_distance=('Distance', 'mean'),
    median_distance=('Distance', 'median'),
    min_distance=('Distance', 'min'),
    max_distance=('Distance', 'max')
).reset_index()
df_distance_stats_cell_type_level
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&#10;    .dataframe tbody tr th {
        vertical-align: top;
    }
&#10;    .dataframe thead th {
        text-align: right;
    }
</style>

<table class="dataframe" data-quarto-postprocess="true" data-border="1">
<thead>
<tr style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Level Three Cell Type</th>
<th data-quarto-table-cell-role="th">Unique Region</th>
<th data-quarto-table-cell-role="th">mean_distance</th>
<th data-quarto-table-cell-role="th">median_distance</th>
<th data-quarto-table-cell-role="th">min_distance</th>
<th data-quarto-table-cell-role="th">max_distance</th>
</tr>
</thead>
<tbody>
<tr>
<td data-quarto-table-cell-role="th">0</td>
<td>adipocyte</td>
<td>xenium-stanford</td>
<td>19.307335</td>
<td>15.506267</td>
<td>1.886588</td>
<td>179.829816</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">1</td>
<td>b cell</td>
<td>cycif-sorgerlab</td>
<td>44.742812</td>
<td>36.696395</td>
<td>3.812328</td>
<td>199.963430</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">2</td>
<td>b cell:memory</td>
<td>xenium-stanford</td>
<td>23.934378</td>
<td>20.983564</td>
<td>2.652329</td>
<td>166.226299</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">3</td>
<td>b cell:naive</td>
<td>xenium-stanford</td>
<td>24.730393</td>
<td>21.919130</td>
<td>2.399703</td>
<td>158.517322</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">4</td>
<td>dendritic cell</td>
<td>xenium-stanford</td>
<td>19.604743</td>
<td>16.317067</td>
<td>3.127862</td>
<td>82.356448</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">5</td>
<td>endothelial cell of lymphatic vessel</td>
<td>xenium-stanford</td>
<td>20.220957</td>
<td>16.182602</td>
<td>1.837223</td>
<td>191.459774</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">6</td>
<td>enterocyte</td>
<td>xenium-stanford</td>
<td>50.881839</td>
<td>44.856792</td>
<td>2.963287</td>
<td>199.368285</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">7</td>
<td>enterocyte:immature</td>
<td>xenium-stanford</td>
<td>40.557414</td>
<td>34.829782</td>
<td>1.689435</td>
<td>199.988725</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">8</td>
<td>enterocyte:progenitor</td>
<td>xenium-stanford</td>
<td>33.809577</td>
<td>30.032085</td>
<td>1.776411</td>
<td>198.196246</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">9</td>
<td>enteroendocrine cell</td>
<td>xenium-stanford</td>
<td>28.989088</td>
<td>25.386019</td>
<td>1.870109</td>
<td>187.875767</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">10</td>
<td>enteroycte:best4+</td>
<td>xenium-stanford</td>
<td>37.294043</td>
<td>33.070860</td>
<td>2.014740</td>
<td>196.207334</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">11</td>
<td>epithelial cell:ki67+ proliferating tumor</td>
<td>cycif-sorgerlab</td>
<td>54.524579</td>
<td>47.126741</td>
<td>4.902750</td>
<td>199.978230</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">12</td>
<td>epithelial cell:pdl1+ tumor</td>
<td>cycif-sorgerlab</td>
<td>52.223131</td>
<td>44.654349</td>
<td>5.014530</td>
<td>199.863917</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">13</td>
<td>fibroblast:cancer associated</td>
<td>xenium-stanford</td>
<td>18.840371</td>
<td>15.427564</td>
<td>1.097860</td>
<td>194.833536</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">14</td>
<td>fibroblast:crypt 1</td>
<td>xenium-stanford</td>
<td>20.939047</td>
<td>16.763710</td>
<td>1.152582</td>
<td>183.642976</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">15</td>
<td>fibroblast:crypt 2</td>
<td>xenium-stanford</td>
<td>19.641772</td>
<td>15.547418</td>
<td>2.245442</td>
<td>178.327889</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">16</td>
<td>fibroblast:crypt 3</td>
<td>xenium-stanford</td>
<td>21.084090</td>
<td>17.340476</td>
<td>2.056888</td>
<td>152.235901</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">17</td>
<td>fibroblast:crypt 4</td>
<td>xenium-stanford</td>
<td>19.255869</td>
<td>15.785117</td>
<td>2.036592</td>
<td>188.046806</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">18</td>
<td>fibroblast:wnt5b+ villus</td>
<td>xenium-stanford</td>
<td>22.921840</td>
<td>18.785960</td>
<td>1.810569</td>
<td>197.299831</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">19</td>
<td>glial cell</td>
<td>xenium-stanford</td>
<td>22.059399</td>
<td>17.544022</td>
<td>1.767815</td>
<td>198.410186</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">20</td>
<td>goblet cell</td>
<td>xenium-stanford</td>
<td>33.697180</td>
<td>28.314876</td>
<td>2.175424</td>
<td>199.344614</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">21</td>
<td>goblet cell:immature</td>
<td>xenium-stanford</td>
<td>32.746761</td>
<td>29.297656</td>
<td>0.657771</td>
<td>199.932057</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">22</td>
<td>lymphocyte:double-negative</td>
<td>cycif-sorgerlab</td>
<td>41.206296</td>
<td>30.842765</td>
<td>4.796007</td>
<td>199.954444</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">23</td>
<td>lymphocyte:double-positive alpha-beta</td>
<td>cycif-sorgerlab</td>
<td>42.782968</td>
<td>35.938167</td>
<td>4.867016</td>
<td>199.938330</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">24</td>
<td>lymphocyte:iii</td>
<td>cycif-sorgerlab</td>
<td>47.359164</td>
<td>35.375846</td>
<td>4.162606</td>
<td>199.993909</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">25</td>
<td>lymphocyte:pdl1+</td>
<td>cycif-sorgerlab</td>
<td>35.163868</td>
<td>27.508832</td>
<td>4.779693</td>
<td>199.928861</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">26</td>
<td>lymphoid cell:innate</td>
<td>xenium-stanford</td>
<td>18.157623</td>
<td>17.780635</td>
<td>3.743766</td>
<td>38.542071</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">27</td>
<td>macrophage</td>
<td>xenium-stanford</td>
<td>17.955820</td>
<td>14.656862</td>
<td>1.547417</td>
<td>195.141153</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">28</td>
<td>macrophage:i</td>
<td>cycif-sorgerlab</td>
<td>38.483925</td>
<td>28.255123</td>
<td>4.405694</td>
<td>199.940381</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">29</td>
<td>macrophage:ii</td>
<td>cycif-sorgerlab</td>
<td>38.832018</td>
<td>30.157804</td>
<td>4.922261</td>
<td>199.976339</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">30</td>
<td>macrophage:iii</td>
<td>cycif-sorgerlab</td>
<td>45.983769</td>
<td>34.746116</td>
<td>4.423528</td>
<td>199.996448</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">31</td>
<td>macrophage:iv</td>
<td>cycif-sorgerlab</td>
<td>45.893683</td>
<td>35.164175</td>
<td>4.732177</td>
<td>199.989362</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">32</td>
<td>macrophage:pdl1+</td>
<td>cycif-sorgerlab</td>
<td>41.905700</td>
<td>34.802750</td>
<td>4.440411</td>
<td>199.946237</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">33</td>
<td>mast cell</td>
<td>xenium-stanford</td>
<td>18.454766</td>
<td>15.402588</td>
<td>2.088500</td>
<td>176.025592</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">34</td>
<td>myofibroblast</td>
<td>cycif-sorgerlab</td>
<td>48.551081</td>
<td>39.884627</td>
<td>3.859785</td>
<td>199.995059</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">35</td>
<td>myofibroblast cell:smooth muscle 1</td>
<td>xenium-stanford</td>
<td>23.465234</td>
<td>18.905669</td>
<td>1.743363</td>
<td>195.859268</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">36</td>
<td>myofibroblast cell:smooth muscle 2</td>
<td>xenium-stanford</td>
<td>23.503984</td>
<td>19.103104</td>
<td>2.537373</td>
<td>193.737832</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">37</td>
<td>myofibroblast cell:smooth muscle 3</td>
<td>xenium-stanford</td>
<td>23.681475</td>
<td>19.625080</td>
<td>1.369424</td>
<td>194.418289</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">38</td>
<td>neoplastic cell</td>
<td>cycif-sorgerlab</td>
<td>59.784714</td>
<td>50.975228</td>
<td>4.447199</td>
<td>199.999898</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">39</td>
<td>neuron</td>
<td>xenium-stanford</td>
<td>22.678683</td>
<td>18.777829</td>
<td>2.719914</td>
<td>159.601136</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">40</td>
<td>pericyte</td>
<td>xenium-stanford</td>
<td>21.258422</td>
<td>16.283206</td>
<td>1.592156</td>
<td>154.814276</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">41</td>
<td>plasma cell</td>
<td>xenium-stanford</td>
<td>17.203358</td>
<td>13.864204</td>
<td>1.545798</td>
<td>193.686073</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">42</td>
<td>stem cell</td>
<td>xenium-stanford</td>
<td>31.434218</td>
<td>28.909495</td>
<td>1.385274</td>
<td>199.354161</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">43</td>
<td>t cell:cd4+</td>
<td>cycif-sorgerlab</td>
<td>38.980845</td>
<td>30.066444</td>
<td>4.281592</td>
<td>199.971584</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">44</td>
<td>t cell:cd4+ alpha-beta</td>
<td>xenium-stanford</td>
<td>21.072560</td>
<td>17.775179</td>
<td>2.182803</td>
<td>197.728143</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">45</td>
<td>t cell:cd4+ pdl1+</td>
<td>cycif-sorgerlab</td>
<td>40.801490</td>
<td>33.508351</td>
<td>4.445378</td>
<td>199.927999</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">46</td>
<td>t cell:cd8+</td>
<td>cycif-sorgerlab</td>
<td>47.833883</td>
<td>38.006688</td>
<td>4.489292</td>
<td>199.994514</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">47</td>
<td>t cell:cd8+ alpha-beta effector memory</td>
<td>xenium-stanford</td>
<td>19.464183</td>
<td>16.545974</td>
<td>1.759058</td>
<td>195.781337</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">48</td>
<td>t cell:cd8+ pdl1+</td>
<td>cycif-sorgerlab</td>
<td>36.841122</td>
<td>29.307785</td>
<td>4.702515</td>
<td>199.534678</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">49</td>
<td>t cell:naive</td>
<td>xenium-stanford</td>
<td>21.369474</td>
<td>18.820881</td>
<td>2.670880</td>
<td>182.335436</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">50</td>
<td>t cell:regulatory</td>
<td>cycif-sorgerlab</td>
<td>33.896390</td>
<td>26.884923</td>
<td>4.275885</td>
<td>199.965529</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">51</td>
<td>t cell:regulatory</td>
<td>xenium-stanford</td>
<td>20.982061</td>
<td>17.604950</td>
<td>2.425589</td>
<td>144.445964</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">52</td>
<td>transit amplifying cell</td>
<td>xenium-stanford</td>
<td>31.647644</td>
<td>28.253443</td>
<td>1.416608</td>
<td>199.955450</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">53</td>
<td>transit amplifying cell:proliferating</td>
<td>xenium-stanford</td>
<td>29.750915</td>
<td>25.985201</td>
<td>1.732760</td>
<td>199.762275</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">54</td>
<td>tuft cell:intestinal</td>
<td>xenium-stanford</td>
<td>31.969551</td>
<td>29.702991</td>
<td>2.702540</td>
<td>148.896183</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">55</td>
<td>unknown cell</td>
<td>cycif-sorgerlab</td>
<td>45.301241</td>
<td>32.613405</td>
<td>4.331525</td>
<td>199.996828</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">56</td>
<td>unknown cell</td>
<td>xenium-stanford</td>
<td>26.071766</td>
<td>19.994800</td>
<td>1.746407</td>
<td>199.995802</td>
</tr>
</tbody>
</table>

</div>

``` python
# Get top and bottom cell types for each unique region in the dataset.
unique_regions = df_all_edges_with_cell_type_level['Unique Region'].unique()
for region in unique_regions:
    top_bottom = get_top_bottom_cell_types_by_mean(df_all_edges_with_cell_type_level, cell_type_level, region)
    print(f"\nTop 5 cell types in {region}:")
    print(top_bottom[0])
    print(f"\nBottom 5 cell types in {region}:")
    print(top_bottom[1])
```


    Top 5 cell types in xenium-stanford:
        Level Three Cell Type  mean_distance
    5              enterocyte      50.881839
    6     enterocyte:immature      40.557414
    9       enteroycte:best4+      37.294043
    7   enterocyte:progenitor      33.809577
    17            goblet cell      33.697180

    Bottom 5 cell types in xenium-stanford:
               Level Three Cell Type  mean_distance
    10  fibroblast:cancer associated      18.840371
    21                     mast cell      18.454766
    19          lymphoid cell:innate      18.157623
    20                    macrophage      17.955820
    27                   plasma cell      17.203358

    Top 5 cell types in cycif-sorgerlab:
                            Level Three Cell Type  mean_distance
    13                            neoplastic cell      59.784714
    1   epithelial cell:ki67+ proliferating tumor      54.524579
    2                 epithelial cell:pdl1+ tumor      52.223131
    12                              myofibroblast      48.551081
    16                                t cell:cd8+      47.833883

    Bottom 5 cell types in cycif-sorgerlab:
       Level Three Cell Type  mean_distance
    8          macrophage:ii      38.832018
    7           macrophage:i      38.483925
    17     t cell:cd8+ pdl1+      36.841122
    6       lymphocyte:pdl1+      35.163868
    18     t cell:regulatory      33.896390

``` python
# Get top and bottom cell types for each unique region in the dataset.
unique_regions = df_all_edges_with_cell_type_level['Unique Region'].unique()
for region in unique_regions:
    top_bottom = get_top_bottom_cell_types_by_median(df_all_edges_with_cell_type_level, cell_type_level, region)
    print(f"\nTop 5 cell types in {region}:")
    print(top_bottom[0])
    print(f"\nBottom 5 cell types in {region}:")
    print(top_bottom[1])
```


    Top 5 cell types in xenium-stanford:
        Level Three Cell Type  median_distance
    5              enterocyte        44.856792
    6     enterocyte:immature        34.829782
    9       enteroycte:best4+        33.070860
    7   enterocyte:progenitor        30.032085
    35   tuft cell:intestinal        29.702991

    Bottom 5 cell types in xenium-stanford:
               Level Three Cell Type  median_distance
    0                      adipocyte        15.506267
    10  fibroblast:cancer associated        15.427564
    21                     mast cell        15.402588
    20                    macrophage        14.656862
    27                   plasma cell        13.864204

    Top 5 cell types in cycif-sorgerlab:
                            Level Three Cell Type  median_distance
    13                            neoplastic cell        50.975228
    1   epithelial cell:ki67+ proliferating tumor        47.126741
    2                 epithelial cell:pdl1+ tumor        44.654349
    12                              myofibroblast        39.884627
    16                                t cell:cd8+        38.006688

    Bottom 5 cell types in cycif-sorgerlab:
       Level Three Cell Type  median_distance
    14           t cell:cd4+        30.066444
    17     t cell:cd8+ pdl1+        29.307785
    7           macrophage:i        28.255123
    6       lymphocyte:pdl1+        27.508832
    18     t cell:regulatory        26.884923

``` python
calculate_regional_variability(df_all_edges_with_cell_type_level, cell_type_level)
```


    Regional Variability Analysis:
    Mean: Average distance in each region
    Std: Standard deviation of distances
    CV: Coefficient of Variation (std/mean * 100%)
                      mean    std  CV (%)
    Unique Region                        
    cycif-sorgerlab  51.00  35.96    70.5
    xenium-stanford  28.17  19.20    68.2

    Cell Type Variability Analysis (sorted by CV):
                                                mean    std  CV (%)
    Level Three Cell Type                                          
    unknown cell                               42.93  37.03    86.3
    macrophage:i                               38.48  31.75    82.5
    lymphocyte:double-negative                 41.21  33.52    81.3
    lymphocyte:iii                             47.36  38.13    80.5
    macrophage:iii                             45.98  36.40    79.2
    macrophage:iv                              45.89  35.94    78.3
    pericyte                                   21.26  16.63    78.2
    t cell:cd4+                                38.98  30.34    77.8
    fibroblast:crypt 2                         19.64  15.27    77.7
    endothelial cell of lymphatic vessel       20.22  15.35    75.9
    lymphocyte:pdl1+                           35.16  26.64    75.8
    macrophage:ii                              38.83  29.21    75.2
    fibroblast:crypt 1                         20.94  15.58    74.4
    t cell:cd8+                                47.83  35.45    74.1
    glial cell                                 22.06  16.31    73.9
    fibroblast:wnt5b+ villus                   22.92  16.86    73.6
    t cell:cd8+ pdl1+                          36.84  27.12    73.6
    myofibroblast cell:smooth muscle 2         23.50  17.24    73.4
    t cell:regulatory                          33.78  24.67    73.0
    adipocyte                                  19.31  14.10    73.0
    plasma cell                                17.20  12.53    72.8
    myofibroblast cell:smooth muscle 1         23.47  16.78    71.5
    myofibroblast                              48.55  34.69    71.5
    macrophage                                 17.96  12.78    71.2
    fibroblast:crypt 4                         19.26  13.53    70.2
    fibroblast:cancer associated               18.84  13.19    70.0
    myofibroblast cell:smooth muscle 3         23.68  16.49    69.6
    t cell:cd4+ pdl1+                          40.80  28.36    69.5
    b cell                                     44.74  31.06    69.4
    goblet cell                                33.70  23.37    69.3
    neuron                                     22.68  15.63    68.9
    fibroblast:crypt 3                         21.08  14.39    68.3
    macrophage:pdl1+                           41.91  28.50    68.0
    t cell:cd4+ alpha-beta                     21.07  14.31    67.9
    mast cell                                  18.45  12.51    67.8
    dendritic cell                             19.60  13.26    67.7
    lymphocyte:double-positive alpha-beta      42.78  28.11    65.7
    t cell:cd8+ alpha-beta effector memory     19.46  12.76    65.6
    transit amplifying cell:proliferating      29.75  19.42    65.3
    b cell:memory                              23.93  15.31    64.0
    epithelial cell:pdl1+ tumor                52.22  33.07    63.3
    t cell:naive                               21.37  13.53    63.3
    neoplastic cell                            59.78  36.97    61.8
    enterocyte:immature                        40.56  24.94    61.5
    enteroendocrine cell                       28.99  17.56    60.6
    transit amplifying cell                    31.65  19.06    60.2
    b cell:naive                               24.73  14.89    60.2
    epithelial cell:ki67+ proliferating tumor  54.52  32.27    59.2
    enteroycte:best4+                          37.29  21.83    58.5
    enterocyte:progenitor                      33.81  19.47    57.6
    goblet cell:immature                       32.75  18.76    57.3
    enterocyte                                 50.88  27.81    54.7
    stem cell                                  31.43  16.46    52.4
    lymphoid cell:innate                       18.16   9.48    52.2
    tuft cell:intestinal                       31.97  16.41    51.3

``` python
plot_violin_cells_per_celltype(df_all_edges_with_cell_type_level, cell_type_level, os.path.join(basepath, figures_output_dir), density_norm='area')
```

![](10_distance_analysis__colon-cycif-sorgerlab-colon-xenium-stanford_files/figure-commonmark/cell-47-output-1.png)

``` python
plot_distance_distribution_boxplots_by_region(df_all_edges_with_cell_type_level, cell_type_level, os.path.join(basepath, figures_output_dir))
```

![](10_distance_analysis__colon-cycif-sorgerlab-colon-xenium-stanford_files/figure-commonmark/cell-48-output-1.png)

``` python
plot_distance_distribution_heatmap(df_all_edges_with_cell_type_level, cell_type_level, os.path.join(basepath, figures_output_dir))
```

![](10_distance_analysis__colon-cycif-sorgerlab-colon-xenium-stanford_files/figure-commonmark/cell-49-output-1.png)

``` python
plot_violin_plots_all_regions(df_all_edges_with_cell_type_level, cell_type_level, os.path.join(basepath, figures_output_dir), density_norm="count") # Or, density_norm="count" or "area" based on preference.
```

![](10_distance_analysis__colon-cycif-sorgerlab-colon-xenium-stanford_files/figure-commonmark/cell-50-output-1.png)

``` python
plot_violin_cells_per_celltype_split_by_condition(df_all_edges_with_cell_type_level, cell_type_level, os.path.join(basepath, figures_output_dir), density_norm="count") # density_norm="count" or "area" can be used based on preference.
```

![](10_distance_analysis__colon-cycif-sorgerlab-colon-xenium-stanford_files/figure-commonmark/cell-51-output-1.png)
