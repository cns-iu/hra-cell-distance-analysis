# Distance Analysis: bonemarrow-codex-chop


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

``` python
import numpy as np
import pandas as pd
import os
import json
import requests
import shutil
import matplotlib.pyplot as plt
import seaborn as sns
from sklearn.preprocessing import normalize
import plotly.express as px

from _cde_compute_edges_from_nodes import *

pd.set_option('display.max_columns', None)
pd.set_option('display.max_rows', None)

# suppress warnings
import warnings
warnings.filterwarnings("ignore")
```

``` python
basepath = "/u/yashjain/hra-cell-distance-analysis/data"
dataset_dir = "bonemarrow-codex-chop"
data_filedir = os.path.join("data-processed-nodes-with-harmonized-cell-types", dataset_dir)
output_edge_dir = os.path.join("data-processed-edges", dataset_dir)
figures_output_dir = "generated-figures"
```

``` python
# Function to load your data
def load_data(path, edges=False):
    if edges:
        column_names = ['cell_id', 'x1', 'y1', 'z1', 'x2', 'y2', 'z2']
        data = pd.read_csv(path, header=None, names=column_names)
    else:
        data = pd.read_csv(path)
    return data
```

``` python
# Function to read all files ending with "-nodes.csv" in the `data_filedir` directory into a single DataFrame. 
# Another additional column `Dataset` is added to identify the dataset name which comes from the filename before the `-nodes.csv` suffix.

# Additionally, function reads all files ending with "-edges.csv" in the `output_edge_dir` directory into a single DataFrame. 
# Three additional columns are added "Dataset", "Anchor Cell Type", and "Anchor Cell Type Level" to identify the dataset name, anchor cell type, and anchor cell type level respectively which come from the filename before the `.csv` suffix.
# The three additional columns are created by splitting the filename on the `-` character, and extracting the relevant parts.
# On splitting, the first part is the dataset name, second part is the anchor cell type level, and third part is the anchor cell type, and last part is the `edges` suffix.
# When reading files, check if the file has the correct format (i.e., ends with `-edges.csv`).

# Additionally, the function merges the edges DataFrame with the nodes DataFrame to get the cell type information for the anchor cells.
# This is done by reading the corresponding nodes file from the `data_filedir` directory for each edges file, and merging it with the edges DataFrame on the `cell_id` column.
# The merged DataFrame contains the edges with additional columns for the cell type information.

# The function returns three DataFrames:
# 1. `merged_nodes`: DataFrame containing all nodes with an additional column `Dataset`.
# 2. `merged_edges`: DataFrame containing all edges with additional columns `Dataset`, `Anchor Cell Type`, and `Anchor Cell Type Level`.
# 3. `merged_nodes_for_all_edges`: DataFrame containing all edges with additional columns `Dataset`, `Anchor Cell Type`, `Anchor Cell Type Level`, and the cell type information for cells.
def read_all_edge_datasets(basepath, data_filedir, output_edge_dir):
    all_nodes_files = []
    all_edges_files = []
    all_nodes_edges_files = []
    for file in os.listdir(os.path.join(basepath, output_edge_dir)):
        if file.endswith("-edges.csv"):
            file_path = os.path.join(basepath, output_edge_dir, file)
            dataset_name, anchor_cell_type_level, anchor_cell_type = file.replace("-edges.csv", "").split('-')
            edges_df = load_data(file_path, edges=False)
            edges_df['Dataset'] = dataset_name
            edges_df['Anchor Cell Type'] = anchor_cell_type
            edges_df['Anchor Cell Type Level'] = anchor_cell_type_level
            edges_df.rename(columns={"distance": "Distance"}, inplace=True) # Rename column "distance" to "Distance".
            all_edges_files.append(edges_df)

            # Read the corresponding nodes file from data_filedir to get the cell type information
            nodes_file_path = os.path.join(basepath, data_filedir, f"{dataset_name}-nodes.csv")
            nodes_df = load_data(nodes_file_path)
            nodes_df['Dataset'] = dataset_name
            all_nodes_files.append(nodes_df)

            # Add a new 'cell_id' column to nodes_df
            nodes_df['cell_id'] = range(len(nodes_df))
            # Set 'cell_id' column as index for nodes_df
            nodes_df.set_index('cell_id', inplace=True)
            # Merge edges_df with nodes_df to get the cell type information for the anchor cells
            edges_nodes_df = pd.merge(edges_df, nodes_df[['Level Three Cell Type', 'Level Two Cell Type', 'Level One Cell Type']], how='left', left_on='cell_id', right_index=True)
            all_nodes_edges_files.append(edges_nodes_df)

    
    merged_edges = pd.concat(all_edges_files, ignore_index=True)
    merged_nodes = pd.concat(all_nodes_files, ignore_index=True)
    merged_nodes_for_all_edges = pd.concat(all_nodes_edges_files, ignore_index=True) 

    return merged_nodes, merged_edges, merged_nodes_for_all_edges
```

``` python
def create_directory(directory):
    if not os.path.exists(directory):
        os.makedirs(directory)
        print(f"Directory '{directory}' created successfully.")
    else:
        print(f"Directory '{directory}' already exists.")
```

## Get initial statistics and identify endothelial cell categories for dataset.

``` python
df_all_nodes, df_all_edges, df_all_edges_with_cell_types = read_all_edge_datasets(basepath, data_filedir, output_edge_dir)
```

``` python
df_all_nodes.head(5)
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&#10;    .dataframe tbody tr th {
        vertical-align: top;
    }
&#10;    .dataframe thead th {
        text-align: right;
    }
</style>

<table class="dataframe" data-quarto-postprocess="true" data-border="1">
<thead>
<tr style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">x</th>
<th data-quarto-table-cell-role="th">y</th>
<th data-quarto-table-cell-role="th">Original Cell Type</th>
<th data-quarto-table-cell-role="th">Level Three Cell Type</th>
<th data-quarto-table-cell-role="th">Level Three CL Label</th>
<th data-quarto-table-cell-role="th">Level Three CL ID</th>
<th data-quarto-table-cell-role="th">CL_Match/3</th>
<th data-quarto-table-cell-role="th">Level Two Cell Type</th>
<th data-quarto-table-cell-role="th">Level Two CL Label</th>
<th data-quarto-table-cell-role="th">Level Two CL ID</th>
<th data-quarto-table-cell-role="th">CL_Match/2</th>
<th data-quarto-table-cell-role="th">Level One Cell Type</th>
<th data-quarto-table-cell-role="th">Level One CL Label</th>
<th data-quarto-table-cell-role="th">Level One CL ID</th>
<th data-quarto-table-cell-role="th">CL_Match/1</th>
<th data-quarto-table-cell-role="th">Dataset</th>
</tr>
</thead>
<tbody>
<tr>
<td data-quarto-table-cell-role="th">0</td>
<td>5776.546667</td>
<td>4000.546667</td>
<td>Erythroid</td>
<td>erythroid lineage cell</td>
<td>erythroid lineage cell</td>
<td>CL:0000764</td>
<td>skos:exactMatch</td>
<td>erythroid precursor</td>
<td>erythroid progenitor cell</td>
<td>CL:0000038</td>
<td>skos:exactMatch</td>
<td>hematopoietic precursor cell</td>
<td>hematopoietic precursor cell</td>
<td>CL:0008001</td>
<td>skos:exactMatch</td>
<td>SB67_NBM48_NSM1_1720</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">1</td>
<td>6406.298077</td>
<td>4001.134615</td>
<td>B-Cells</td>
<td>b cell</td>
<td>B cell</td>
<td>CL:0000236</td>
<td>skos:exactMatch</td>
<td>b cell</td>
<td>B cell</td>
<td>CL:0000236</td>
<td>skos:exactMatch</td>
<td>immune cell</td>
<td>leukocyte</td>
<td>CL:0000738</td>
<td>skos:exactMatch</td>
<td>SB67_NBM48_NSM1_1720</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">2</td>
<td>6805.010526</td>
<td>4000.701754</td>
<td>Erythroid</td>
<td>erythroid lineage cell</td>
<td>erythroid lineage cell</td>
<td>CL:0000764</td>
<td>skos:exactMatch</td>
<td>erythroid precursor</td>
<td>erythroid progenitor cell</td>
<td>CL:0000038</td>
<td>skos:exactMatch</td>
<td>hematopoietic precursor cell</td>
<td>hematopoietic precursor cell</td>
<td>CL:0008001</td>
<td>skos:exactMatch</td>
<td>SB67_NBM48_NSM1_1720</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">3</td>
<td>6032.794326</td>
<td>4002.039007</td>
<td>AEC</td>
<td>endothelial cell of artery</td>
<td>endothelial cell of artery</td>
<td>CL:1000413</td>
<td>skos:exactMatch</td>
<td>endothelial cell of artery</td>
<td>endothelial cell of artery</td>
<td>CL:1000413</td>
<td>skos:exactMatch</td>
<td>endothelial cell</td>
<td>endothelial cell</td>
<td>CL:0000115</td>
<td>skos:exactMatch</td>
<td>SB67_NBM48_NSM1_1720</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">4</td>
<td>6159.116364</td>
<td>4001.763636</td>
<td>Early Myeloid Progenitor</td>
<td>myeloid progenitor cell:common</td>
<td>common myeloid progenitor</td>
<td>CL:0000049</td>
<td>skos:exactMatch</td>
<td>progenitor cell</td>
<td>hematopoietic precursor cell</td>
<td>CL:0008001</td>
<td>skos:exactMatch</td>
<td>hematopoietic precursor cell</td>
<td>hematopoietic precursor cell</td>
<td>CL:0008001</td>
<td>skos:exactMatch</td>
<td>SB67_NBM48_NSM1_1720</td>
</tr>
</tbody>
</table>

</div>

``` python
# Print the total number of unique cell types per dataset. Compute separately for each cell type column (Level One Cell Type, Level Two Cell Type, Level Three Cell Type, Original Cell Type).
print("Total number of unique cell types per cell type annnotation level:")
unique_cell_types = {
    'Original Cell Type': df_all_nodes['Original Cell Type'].nunique(),
    'Level Three Cell Type': df_all_nodes['Level Three Cell Type'].nunique(),
    'Level Two Cell Type': df_all_nodes['Level Two Cell Type'].nunique(),
    'Level One Cell Type': df_all_nodes['Level One Cell Type'].nunique()
}
for cell_type, count in unique_cell_types.items():
    print(f"{cell_type}: {count}")
```

    Total number of unique cell types per cell type annnotation level:
    Original Cell Type: 37
    Level Three Cell Type: 33
    Level Two Cell Type: 22
    Level One Cell Type: 6

``` python
# Save the unique cell types containing "endothelial" in name per cell type column (Level One Cell Type, Level Two Cell Type, Level Three Cell Type, Original Cell Type) to a dictionary where the key is the level and the value is a list of unique cell types.
endothelial_cell_types = {
    'Original Cell Type': df_all_nodes[df_all_nodes['Original Cell Type'].str.contains("endothelial", case=False, na=False)]['Original Cell Type'].unique().tolist(),
    'Level Three Cell Type': df_all_nodes[df_all_nodes['Level Three Cell Type'].str.contains("endothelial", case=False, na=False)]['Level Three Cell Type'].unique().tolist(),
    'Level Two Cell Type': df_all_nodes[df_all_nodes['Level Two Cell Type'].str.contains("endothelial", case=False, na=False)]['Level Two Cell Type'].unique().tolist(),
    'Level One Cell Type': df_all_nodes[df_all_nodes['Level One Cell Type'].str.contains("endothelial", case=False, na=False)]['Level One Cell Type'].unique().tolist()
}

print("\nEndothelial cell types per cell type annotation level:")
for level, cell_types in endothelial_cell_types.items():
    print(f"\n{level}:")
    for cell in cell_types:
        print(f"  - {cell}")
```


    Endothelial cell types per cell type annotation level:

    Original Cell Type:

    Level Three Cell Type:
      - endothelial cell of artery
      - endothelial cell of sinusoid

    Level Two Cell Type:
      - endothelial cell of artery
      - endothelial cell of sinusoid

    Level One Cell Type:
      - endothelial cell

``` python
type_field_list = ["Level Three Cell Type", "Level Two Cell Type", "Level One Cell Type"] # Skipping Original Cell Type as it is not a hierarchical level.

# Define the anchor cell type (type of endothelial cell) for each level in type_field_list based on available categories in the previous cell. The distance analysis at all three levels will be limited to the specified anchor cell type.
anchor_cell_type_dict = {
    'Level Three Cell Type': 'endothelial cell of sinusoid', # Picking sinusoid instead of artery because the cell count of sinusoid is higher than artery in the dataset.
    'Level Two Cell Type': 'endothelial cell of sinusoid',
    'Level One Cell Type': 'endothelial cell'
}
```

## Process datasets to add region information to Nodes files.

``` python
# Print unique values in Dataset column as a list.
print("\nUnique values in Dataset column:")
print(df_all_edges['Dataset'].unique().tolist())
```


    Unique values in Dataset column:
    ['SB67_NBM48_NSM1_1720', 'SB67_NBM49_NSM2_1086', 'SB67_NBM47_NSM3_1996', 'SB67_NBM51_AML1_183', 'SB67_NBM46_AML1_382', 'SB67_NBM44_AML2_191', 'SB67_NBM52_AML3_1329', 'SB67_NBM54_AML3_1443', 'SB67_NBM27_H10', 'SB67_NBM28_H14', 'SB67_NBM36_H26', 'SB67_NBM41_H27', 'SB67_NBM31_H32', 'SB67_NBM38_H33', 'SB67_NBM37_H35', 'SB67_NBM33_H36', 'SB67_NBM32_H37', 'SB67_NBM34_H38', 'SB67_NBM40_H39', 'SB67_NBM39_H41']

``` python
# Create a dictionary to map bone marrow regions to correct region names (conditions).
# AML = Acute Myeloid Leukemia
# NSM = Negative lymphoma Staging bone Marrow biopsies
# NBM = Normal Bone Marrow
region_map = {
    'SB67_NBM48_NSM1_1720': 'NSM', 
    'SB67_NBM49_NSM2_1086': 'NSM', 
    'SB67_NBM47_NSM3_1996': 'NSM', 
    'SB67_NBM51_AML1_183': 'AML', 
    'SB67_NBM46_AML1_382': 'AML', 
    'SB67_NBM44_AML2_191': 'AML', 
    'SB67_NBM52_AML3_1329': 'AML', 
    'SB67_NBM54_AML3_1443': 'AML', 
    'SB67_NBM27_H10': 'NBM', 
    'SB67_NBM28_H14': 'NBM', 
    'SB67_NBM36_H26': 'NBM', 
    'SB67_NBM41_H27': 'NBM', 
    'SB67_NBM31_H32': 'NBM', 
    'SB67_NBM38_H33': 'NBM', 
    'SB67_NBM37_H35': 'NBM', 
    'SB67_NBM33_H36': 'NBM', 
    'SB67_NBM32_H37': 'NBM', 
    'SB67_NBM34_H38': 'NBM', 
    'SB67_NBM40_H39': 'NBM', 
    'SB67_NBM39_H41': 'NBM'
}
```

``` python
df_all_nodes.head()
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&#10;    .dataframe tbody tr th {
        vertical-align: top;
    }
&#10;    .dataframe thead th {
        text-align: right;
    }
</style>

<table class="dataframe" data-quarto-postprocess="true" data-border="1">
<thead>
<tr style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">x</th>
<th data-quarto-table-cell-role="th">y</th>
<th data-quarto-table-cell-role="th">Original Cell Type</th>
<th data-quarto-table-cell-role="th">Level Three Cell Type</th>
<th data-quarto-table-cell-role="th">Level Three CL Label</th>
<th data-quarto-table-cell-role="th">Level Three CL ID</th>
<th data-quarto-table-cell-role="th">CL_Match/3</th>
<th data-quarto-table-cell-role="th">Level Two Cell Type</th>
<th data-quarto-table-cell-role="th">Level Two CL Label</th>
<th data-quarto-table-cell-role="th">Level Two CL ID</th>
<th data-quarto-table-cell-role="th">CL_Match/2</th>
<th data-quarto-table-cell-role="th">Level One Cell Type</th>
<th data-quarto-table-cell-role="th">Level One CL Label</th>
<th data-quarto-table-cell-role="th">Level One CL ID</th>
<th data-quarto-table-cell-role="th">CL_Match/1</th>
<th data-quarto-table-cell-role="th">Dataset</th>
</tr>
</thead>
<tbody>
<tr>
<td data-quarto-table-cell-role="th">0</td>
<td>5776.546667</td>
<td>4000.546667</td>
<td>Erythroid</td>
<td>erythroid lineage cell</td>
<td>erythroid lineage cell</td>
<td>CL:0000764</td>
<td>skos:exactMatch</td>
<td>erythroid precursor</td>
<td>erythroid progenitor cell</td>
<td>CL:0000038</td>
<td>skos:exactMatch</td>
<td>hematopoietic precursor cell</td>
<td>hematopoietic precursor cell</td>
<td>CL:0008001</td>
<td>skos:exactMatch</td>
<td>SB67_NBM48_NSM1_1720</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">1</td>
<td>6406.298077</td>
<td>4001.134615</td>
<td>B-Cells</td>
<td>b cell</td>
<td>B cell</td>
<td>CL:0000236</td>
<td>skos:exactMatch</td>
<td>b cell</td>
<td>B cell</td>
<td>CL:0000236</td>
<td>skos:exactMatch</td>
<td>immune cell</td>
<td>leukocyte</td>
<td>CL:0000738</td>
<td>skos:exactMatch</td>
<td>SB67_NBM48_NSM1_1720</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">2</td>
<td>6805.010526</td>
<td>4000.701754</td>
<td>Erythroid</td>
<td>erythroid lineage cell</td>
<td>erythroid lineage cell</td>
<td>CL:0000764</td>
<td>skos:exactMatch</td>
<td>erythroid precursor</td>
<td>erythroid progenitor cell</td>
<td>CL:0000038</td>
<td>skos:exactMatch</td>
<td>hematopoietic precursor cell</td>
<td>hematopoietic precursor cell</td>
<td>CL:0008001</td>
<td>skos:exactMatch</td>
<td>SB67_NBM48_NSM1_1720</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">3</td>
<td>6032.794326</td>
<td>4002.039007</td>
<td>AEC</td>
<td>endothelial cell of artery</td>
<td>endothelial cell of artery</td>
<td>CL:1000413</td>
<td>skos:exactMatch</td>
<td>endothelial cell of artery</td>
<td>endothelial cell of artery</td>
<td>CL:1000413</td>
<td>skos:exactMatch</td>
<td>endothelial cell</td>
<td>endothelial cell</td>
<td>CL:0000115</td>
<td>skos:exactMatch</td>
<td>SB67_NBM48_NSM1_1720</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">4</td>
<td>6159.116364</td>
<td>4001.763636</td>
<td>Early Myeloid Progenitor</td>
<td>myeloid progenitor cell:common</td>
<td>common myeloid progenitor</td>
<td>CL:0000049</td>
<td>skos:exactMatch</td>
<td>progenitor cell</td>
<td>hematopoietic precursor cell</td>
<td>CL:0008001</td>
<td>skos:exactMatch</td>
<td>hematopoietic precursor cell</td>
<td>hematopoietic precursor cell</td>
<td>CL:0008001</td>
<td>skos:exactMatch</td>
<td>SB67_NBM48_NSM1_1720</td>
</tr>
</tbody>
</table>

</div>

``` python
# Iterate through the df_all_data dataframe to create new column "Unique Region" based on the "Dataset" column.
# The "Unique Region" column is created by mapping the region names based on the full dataset name.
df_all_nodes['Unique Region'] = df_all_nodes['Dataset'].map(region_map)
# df_all_nodes['Unique Region'] = df_all_nodes['Dataset'].str.split('-').str[1].map(region_map)

# Check if the new columns are created correctly.
df_all_nodes[['Dataset', 'Unique Region']].head(5)
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&#10;    .dataframe tbody tr th {
        vertical-align: top;
    }
&#10;    .dataframe thead th {
        text-align: right;
    }
</style>

<table class="dataframe" data-quarto-postprocess="true" data-border="1">
<thead>
<tr style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Dataset</th>
<th data-quarto-table-cell-role="th">Unique Region</th>
</tr>
</thead>
<tbody>
<tr>
<td data-quarto-table-cell-role="th">0</td>
<td>SB67_NBM48_NSM1_1720</td>
<td>NSM</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">1</td>
<td>SB67_NBM48_NSM1_1720</td>
<td>NSM</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">2</td>
<td>SB67_NBM48_NSM1_1720</td>
<td>NSM</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">3</td>
<td>SB67_NBM48_NSM1_1720</td>
<td>NSM</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">4</td>
<td>SB67_NBM48_NSM1_1720</td>
<td>NSM</td>
</tr>
</tbody>
</table>

</div>

``` python
# Print all unique regions in the data.
print("\nUnique Regions in the data:")
print(df_all_nodes['Unique Region'].unique())

# Print the total number of unique regions.
print(f"Total number of unique regions: {df_all_nodes['Unique Region'].nunique()}")

# Print number of unique datasets per unique region.
print("\nNumber of unique datasets per unique region:")
for region in df_all_nodes['Unique Region'].unique():
    num_datasets = df_all_nodes[df_all_nodes['Unique Region'] == region]['Dataset'].nunique()
    print(f"{region}: {num_datasets}")
```


    Unique Regions in the data:
    ['NSM' 'AML' 'NBM']
    Total number of unique regions: 3

    Number of unique datasets per unique region:
    NSM: 3
    AML: 5
    NBM: 12

## Process datasets to add region information to Edges files.

``` python
df_all_edges.head(5)
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&#10;    .dataframe tbody tr th {
        vertical-align: top;
    }
&#10;    .dataframe thead th {
        text-align: right;
    }
</style>

<table class="dataframe" data-quarto-postprocess="true" data-border="1">
<thead>
<tr style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">cell_id</th>
<th data-quarto-table-cell-role="th">x1</th>
<th data-quarto-table-cell-role="th">y1</th>
<th data-quarto-table-cell-role="th">z1</th>
<th data-quarto-table-cell-role="th">x2</th>
<th data-quarto-table-cell-role="th">y2</th>
<th data-quarto-table-cell-role="th">z2</th>
<th data-quarto-table-cell-role="th">Distance</th>
<th data-quarto-table-cell-role="th">Dataset</th>
<th data-quarto-table-cell-role="th">Anchor Cell Type</th>
<th data-quarto-table-cell-role="th">Anchor Cell Type Level</th>
</tr>
</thead>
<tbody>
<tr>
<td data-quarto-table-cell-role="th">0</td>
<td>1117</td>
<td>5746.650000</td>
<td>4541.361111</td>
<td>0</td>
<td>5895.403361</td>
<td>4573.613445</td>
<td>0</td>
<td>152.209644</td>
<td>SB67_NBM48_NSM1_1720</td>
<td>endothelial cell of artery</td>
<td>Level Three Cell Type</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">1</td>
<td>1145</td>
<td>5734.788679</td>
<td>4551.400000</td>
<td>0</td>
<td>5895.403361</td>
<td>4573.613445</td>
<td>0</td>
<td>162.143496</td>
<td>SB67_NBM48_NSM1_1720</td>
<td>endothelial cell of artery</td>
<td>Level Three Cell Type</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">2</td>
<td>1151</td>
<td>5756.300000</td>
<td>4553.104348</td>
<td>0</td>
<td>5895.403361</td>
<td>4573.613445</td>
<td>0</td>
<td>140.607141</td>
<td>SB67_NBM48_NSM1_1720</td>
<td>endothelial cell of artery</td>
<td>Level Three Cell Type</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">3</td>
<td>1185</td>
<td>5746.238095</td>
<td>4563.619048</td>
<td>0</td>
<td>5895.403361</td>
<td>4573.613445</td>
<td>0</td>
<td>149.499714</td>
<td>SB67_NBM48_NSM1_1720</td>
<td>endothelial cell of artery</td>
<td>Level Three Cell Type</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">4</td>
<td>1268</td>
<td>5624.227027</td>
<td>4594.664865</td>
<td>0</td>
<td>5541.917031</td>
<td>4700.170306</td>
<td>0</td>
<td>133.814549</td>
<td>SB67_NBM48_NSM1_1720</td>
<td>endothelial cell of artery</td>
<td>Level Three Cell Type</td>
</tr>
</tbody>
</table>

</div>

``` python
# Process the edge data to create new columns "Unique Region" based on the "Dataset" column, similar to how it was done for the node data.
df_all_edges['Unique Region'] = df_all_edges['Dataset'].map(region_map)

# Check if the new columns are created correctly.
df_all_edges[['Dataset', 'Unique Region']].head(5)
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&#10;    .dataframe tbody tr th {
        vertical-align: top;
    }
&#10;    .dataframe thead th {
        text-align: right;
    }
</style>

<table class="dataframe" data-quarto-postprocess="true" data-border="1">
<thead>
<tr style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Dataset</th>
<th data-quarto-table-cell-role="th">Unique Region</th>
</tr>
</thead>
<tbody>
<tr>
<td data-quarto-table-cell-role="th">0</td>
<td>SB67_NBM48_NSM1_1720</td>
<td>NSM</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">1</td>
<td>SB67_NBM48_NSM1_1720</td>
<td>NSM</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">2</td>
<td>SB67_NBM48_NSM1_1720</td>
<td>NSM</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">3</td>
<td>SB67_NBM48_NSM1_1720</td>
<td>NSM</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">4</td>
<td>SB67_NBM48_NSM1_1720</td>
<td>NSM</td>
</tr>
</tbody>
</table>

</div>

``` python
# Print all unique regions in the data.
print("\nUnique Regions in the data:")
print(df_all_edges['Unique Region'].unique())

# Print the total number of unique regions.
print(f"Total number of unique regions: {df_all_edges['Unique Region'].nunique()}")

# Print number of unique datasets per unique region.
print("\nNumber of unique datasets per unique region:")
for region in df_all_edges['Unique Region'].unique():
    num_datasets = df_all_edges[df_all_edges['Unique Region'] == region]['Dataset'].nunique()
    print(f"{region}: {num_datasets}")
```


    Unique Regions in the data:
    ['NSM' 'AML' 'NBM']
    Total number of unique regions: 3

    Number of unique datasets per unique region:
    NSM: 3
    AML: 5
    NBM: 12

``` python
df_all_edges_with_cell_types['Unique Region'] = df_all_edges_with_cell_types['Dataset'].map(region_map)

# Check if the new columns are created correctly.
df_all_edges_with_cell_types[['Dataset', 'Unique Region']].head(5)
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&#10;    .dataframe tbody tr th {
        vertical-align: top;
    }
&#10;    .dataframe thead th {
        text-align: right;
    }
</style>

<table class="dataframe" data-quarto-postprocess="true" data-border="1">
<thead>
<tr style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Dataset</th>
<th data-quarto-table-cell-role="th">Unique Region</th>
</tr>
</thead>
<tbody>
<tr>
<td data-quarto-table-cell-role="th">0</td>
<td>SB67_NBM48_NSM1_1720</td>
<td>NSM</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">1</td>
<td>SB67_NBM48_NSM1_1720</td>
<td>NSM</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">2</td>
<td>SB67_NBM48_NSM1_1720</td>
<td>NSM</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">3</td>
<td>SB67_NBM48_NSM1_1720</td>
<td>NSM</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">4</td>
<td>SB67_NBM48_NSM1_1720</td>
<td>NSM</td>
</tr>
</tbody>
</table>

</div>

``` python
df_all_nodes.head(1)
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&#10;    .dataframe tbody tr th {
        vertical-align: top;
    }
&#10;    .dataframe thead th {
        text-align: right;
    }
</style>

<table class="dataframe" data-quarto-postprocess="true" data-border="1">
<thead>
<tr style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">x</th>
<th data-quarto-table-cell-role="th">y</th>
<th data-quarto-table-cell-role="th">Original Cell Type</th>
<th data-quarto-table-cell-role="th">Level Three Cell Type</th>
<th data-quarto-table-cell-role="th">Level Three CL Label</th>
<th data-quarto-table-cell-role="th">Level Three CL ID</th>
<th data-quarto-table-cell-role="th">CL_Match/3</th>
<th data-quarto-table-cell-role="th">Level Two Cell Type</th>
<th data-quarto-table-cell-role="th">Level Two CL Label</th>
<th data-quarto-table-cell-role="th">Level Two CL ID</th>
<th data-quarto-table-cell-role="th">CL_Match/2</th>
<th data-quarto-table-cell-role="th">Level One Cell Type</th>
<th data-quarto-table-cell-role="th">Level One CL Label</th>
<th data-quarto-table-cell-role="th">Level One CL ID</th>
<th data-quarto-table-cell-role="th">CL_Match/1</th>
<th data-quarto-table-cell-role="th">Dataset</th>
<th data-quarto-table-cell-role="th">Unique Region</th>
</tr>
</thead>
<tbody>
<tr>
<td data-quarto-table-cell-role="th">0</td>
<td>5776.546667</td>
<td>4000.546667</td>
<td>Erythroid</td>
<td>erythroid lineage cell</td>
<td>erythroid lineage cell</td>
<td>CL:0000764</td>
<td>skos:exactMatch</td>
<td>erythroid precursor</td>
<td>erythroid progenitor cell</td>
<td>CL:0000038</td>
<td>skos:exactMatch</td>
<td>hematopoietic precursor cell</td>
<td>hematopoietic precursor cell</td>
<td>CL:0008001</td>
<td>skos:exactMatch</td>
<td>SB67_NBM48_NSM1_1720</td>
<td>NSM</td>
</tr>
</tbody>
</table>

</div>

``` python
df_all_edges.head(1)
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&#10;    .dataframe tbody tr th {
        vertical-align: top;
    }
&#10;    .dataframe thead th {
        text-align: right;
    }
</style>

<table class="dataframe" data-quarto-postprocess="true" data-border="1">
<thead>
<tr style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">cell_id</th>
<th data-quarto-table-cell-role="th">x1</th>
<th data-quarto-table-cell-role="th">y1</th>
<th data-quarto-table-cell-role="th">z1</th>
<th data-quarto-table-cell-role="th">x2</th>
<th data-quarto-table-cell-role="th">y2</th>
<th data-quarto-table-cell-role="th">z2</th>
<th data-quarto-table-cell-role="th">Distance</th>
<th data-quarto-table-cell-role="th">Dataset</th>
<th data-quarto-table-cell-role="th">Anchor Cell Type</th>
<th data-quarto-table-cell-role="th">Anchor Cell Type Level</th>
<th data-quarto-table-cell-role="th">Unique Region</th>
</tr>
</thead>
<tbody>
<tr>
<td data-quarto-table-cell-role="th">0</td>
<td>1117</td>
<td>5746.65</td>
<td>4541.361111</td>
<td>0</td>
<td>5895.403361</td>
<td>4573.613445</td>
<td>0</td>
<td>152.209644</td>
<td>SB67_NBM48_NSM1_1720</td>
<td>endothelial cell of artery</td>
<td>Level Three Cell Type</td>
<td>NSM</td>
</tr>
</tbody>
</table>

</div>

``` python
df_all_edges_with_cell_types.head(1)
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&#10;    .dataframe tbody tr th {
        vertical-align: top;
    }
&#10;    .dataframe thead th {
        text-align: right;
    }
</style>

<table class="dataframe" data-quarto-postprocess="true" data-border="1">
<thead>
<tr style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">cell_id</th>
<th data-quarto-table-cell-role="th">x1</th>
<th data-quarto-table-cell-role="th">y1</th>
<th data-quarto-table-cell-role="th">z1</th>
<th data-quarto-table-cell-role="th">x2</th>
<th data-quarto-table-cell-role="th">y2</th>
<th data-quarto-table-cell-role="th">z2</th>
<th data-quarto-table-cell-role="th">Distance</th>
<th data-quarto-table-cell-role="th">Dataset</th>
<th data-quarto-table-cell-role="th">Anchor Cell Type</th>
<th data-quarto-table-cell-role="th">Anchor Cell Type Level</th>
<th data-quarto-table-cell-role="th">Level Three Cell Type</th>
<th data-quarto-table-cell-role="th">Level Two Cell Type</th>
<th data-quarto-table-cell-role="th">Level One Cell Type</th>
<th data-quarto-table-cell-role="th">Unique Region</th>
</tr>
</thead>
<tbody>
<tr>
<td data-quarto-table-cell-role="th">0</td>
<td>1117</td>
<td>5746.65</td>
<td>4541.361111</td>
<td>0</td>
<td>5895.403361</td>
<td>4573.613445</td>
<td>0</td>
<td>152.209644</td>
<td>SB67_NBM48_NSM1_1720</td>
<td>endothelial cell of artery</td>
<td>Level Three Cell Type</td>
<td>erythroid lineage cell</td>
<td>erythroid precursor</td>
<td>hematopoietic precursor cell</td>
<td>NSM</td>
</tr>
</tbody>
</table>

</div>

## Node Analysis

``` python
# Plot number of cells per cell type in the same plot. Color by cell type and unique region. Output figure saved in existing `figures_output_dir`.
def plot_cells_per_celltype(df, type_field, output_dir):
    plt.figure(figsize=(20, 8))
    plt.rcParams["svg.fonttype"] = 'none'  # to store text as text, not as path
    sns.countplot(data=df, x=type_field, palette='Spectral', hue='Unique Region')
    plt.title(f'Number of Cells per {type_field} in `{dataset_dir}`')
    plt.xticks(rotation=90)
    plt.tight_layout()
    plt.savefig(os.path.join(output_dir, f'{dataset_dir}_cells_per_celltype_{type_field}.png'), dpi=300,
                bbox_inches='tight',
                pad_inches=0.5)
    plt.savefig(os.path.join(output_dir, f'{dataset_dir}_cells_per_celltype_{type_field}.svg'), dpi=300,
                bbox_inches='tight',
                pad_inches=0.5)
    plt.legend(title='Unique Region', bbox_to_anchor=(0.85, 1), loc='upper left')
    plt.xlabel(type_field)

    # For numbers on y-axis, do not use scientific notation.
    plt.ticklabel_format(style='plain', axis='y')
    # Set y-axis label
    plt.ylabel('Number of Cells')
    plt.grid(axis='y', linestyle='--', alpha=0.7)
    plt.tight_layout()
    # Show the plot
    plt.show()
    plt.close()
for type_field in type_field_list:
    plot_cells_per_celltype(df_all_nodes, type_field, os.path.join(basepath, figures_output_dir))
```

![](09_distance_analysis__bonemarrow-codex-chop_files/figure-commonmark/cell-24-output-1.png)

![](09_distance_analysis__bonemarrow-codex-chop_files/figure-commonmark/cell-24-output-2.png)

![](09_distance_analysis__bonemarrow-codex-chop_files/figure-commonmark/cell-24-output-3.png)

## Distance Analysis

``` python
# Get mean, median, minimum, maximum distance per unique region per anchor cell type.
df_distance_stats = df_all_edges_with_cell_types.groupby(['Unique Region', 'Anchor Cell Type', 'Anchor Cell Type Level']).agg(
    mean_distance=('Distance', 'mean'),
    median_distance=('Distance', 'median'),
    min_distance=('Distance', 'min'),
    max_distance=('Distance', 'max')
).reset_index()
# Print the first few rows of the distance statistics DataFrame.
df_distance_stats
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&#10;    .dataframe tbody tr th {
        vertical-align: top;
    }
&#10;    .dataframe thead th {
        text-align: right;
    }
</style>

<table class="dataframe" data-quarto-postprocess="true" data-border="1">
<thead>
<tr style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Unique Region</th>
<th data-quarto-table-cell-role="th">Anchor Cell Type</th>
<th data-quarto-table-cell-role="th">Anchor Cell Type Level</th>
<th data-quarto-table-cell-role="th">mean_distance</th>
<th data-quarto-table-cell-role="th">median_distance</th>
<th data-quarto-table-cell-role="th">min_distance</th>
<th data-quarto-table-cell-role="th">max_distance</th>
</tr>
</thead>
<tbody>
<tr>
<td data-quarto-table-cell-role="th">0</td>
<td>AML</td>
<td>endothelial cell</td>
<td>Level One Cell Type</td>
<td>74.382151</td>
<td>66.806253</td>
<td>6.056625</td>
<td>199.988548</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">1</td>
<td>AML</td>
<td>endothelial cell of artery</td>
<td>Level Three Cell Type</td>
<td>111.758598</td>
<td>112.688440</td>
<td>8.275107</td>
<td>199.997878</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">2</td>
<td>AML</td>
<td>endothelial cell of artery</td>
<td>Level Two Cell Type</td>
<td>111.758598</td>
<td>112.688440</td>
<td>8.275107</td>
<td>199.997878</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">3</td>
<td>AML</td>
<td>endothelial cell of sinusoid</td>
<td>Level Three Cell Type</td>
<td>79.390329</td>
<td>72.177834</td>
<td>6.056625</td>
<td>199.988548</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">4</td>
<td>AML</td>
<td>endothelial cell of sinusoid</td>
<td>Level Two Cell Type</td>
<td>79.390329</td>
<td>72.177834</td>
<td>6.056625</td>
<td>199.988548</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">5</td>
<td>NBM</td>
<td>endothelial cell</td>
<td>Level One Cell Type</td>
<td>90.322695</td>
<td>85.240398</td>
<td>5.750231</td>
<td>199.999142</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">6</td>
<td>NBM</td>
<td>endothelial cell of artery</td>
<td>Level Three Cell Type</td>
<td>115.284424</td>
<td>119.163665</td>
<td>5.750231</td>
<td>199.999998</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">7</td>
<td>NBM</td>
<td>endothelial cell of artery</td>
<td>Level Two Cell Type</td>
<td>115.284424</td>
<td>119.163665</td>
<td>5.750231</td>
<td>199.999998</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">8</td>
<td>NBM</td>
<td>endothelial cell of sinusoid</td>
<td>Level Three Cell Type</td>
<td>95.298876</td>
<td>91.351118</td>
<td>7.165130</td>
<td>199.999142</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">9</td>
<td>NBM</td>
<td>endothelial cell of sinusoid</td>
<td>Level Two Cell Type</td>
<td>95.298876</td>
<td>91.351118</td>
<td>7.165130</td>
<td>199.999142</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">10</td>
<td>NSM</td>
<td>endothelial cell</td>
<td>Level One Cell Type</td>
<td>93.842789</td>
<td>87.951406</td>
<td>7.675593</td>
<td>199.997910</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">11</td>
<td>NSM</td>
<td>endothelial cell of artery</td>
<td>Level Three Cell Type</td>
<td>117.211880</td>
<td>121.868198</td>
<td>8.340683</td>
<td>199.999051</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">12</td>
<td>NSM</td>
<td>endothelial cell of artery</td>
<td>Level Two Cell Type</td>
<td>117.211880</td>
<td>121.868198</td>
<td>8.340683</td>
<td>199.999051</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">13</td>
<td>NSM</td>
<td>endothelial cell of sinusoid</td>
<td>Level Three Cell Type</td>
<td>95.636834</td>
<td>90.176577</td>
<td>7.675593</td>
<td>199.997910</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">14</td>
<td>NSM</td>
<td>endothelial cell of sinusoid</td>
<td>Level Two Cell Type</td>
<td>95.636834</td>
<td>90.176577</td>
<td>7.675593</td>
<td>199.997910</td>
</tr>
</tbody>
</table>

</div>

### Level One Cell Type Analysis

``` python
# Get mean, median, minimum, maximum distance per cell type in all unique regions.
cell_type_level = 'Level One Cell Type'
df_all_edges_with_cell_type_level = df_all_edges_with_cell_types[(df_all_edges_with_cell_types['Anchor Cell Type Level'] == cell_type_level) & (df_all_edges_with_cell_types['Anchor Cell Type'] == anchor_cell_type_dict[cell_type_level])]

df_distance_stats_cell_type_level = df_all_edges_with_cell_type_level.groupby([cell_type_level, 'Unique Region']).agg(
    mean_distance=('Distance', 'mean'),
    median_distance=('Distance', 'median'),
    min_distance=('Distance', 'min'),
    max_distance=('Distance', 'max')
).reset_index()
df_distance_stats_cell_type_level
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&#10;    .dataframe tbody tr th {
        vertical-align: top;
    }
&#10;    .dataframe thead th {
        text-align: right;
    }
</style>

<table class="dataframe" data-quarto-postprocess="true" data-border="1">
<thead>
<tr style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Level One Cell Type</th>
<th data-quarto-table-cell-role="th">Unique Region</th>
<th data-quarto-table-cell-role="th">mean_distance</th>
<th data-quarto-table-cell-role="th">median_distance</th>
<th data-quarto-table-cell-role="th">min_distance</th>
<th data-quarto-table-cell-role="th">max_distance</th>
</tr>
</thead>
<tbody>
<tr>
<td data-quarto-table-cell-role="th">0</td>
<td>hematopoietic precursor cell</td>
<td>AML</td>
<td>75.807458</td>
<td>68.350787</td>
<td>6.056625</td>
<td>199.982016</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">1</td>
<td>hematopoietic precursor cell</td>
<td>NBM</td>
<td>91.437465</td>
<td>86.347062</td>
<td>7.368943</td>
<td>199.999142</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">2</td>
<td>hematopoietic precursor cell</td>
<td>NSM</td>
<td>95.233485</td>
<td>89.641506</td>
<td>8.036234</td>
<td>199.985663</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">3</td>
<td>immune cell</td>
<td>AML</td>
<td>72.244373</td>
<td>64.713204</td>
<td>8.247845</td>
<td>199.988548</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">4</td>
<td>immune cell</td>
<td>NBM</td>
<td>89.656605</td>
<td>84.596595</td>
<td>5.750231</td>
<td>199.998770</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">5</td>
<td>immune cell</td>
<td>NSM</td>
<td>93.334766</td>
<td>87.175896</td>
<td>7.675593</td>
<td>199.997383</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">6</td>
<td>mesenchymal cell</td>
<td>AML</td>
<td>68.072424</td>
<td>59.045392</td>
<td>8.275107</td>
<td>198.703670</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">7</td>
<td>mesenchymal cell</td>
<td>NBM</td>
<td>82.079626</td>
<td>75.429180</td>
<td>7.596170</td>
<td>199.992343</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">8</td>
<td>mesenchymal cell</td>
<td>NSM</td>
<td>79.140648</td>
<td>69.671854</td>
<td>8.344688</td>
<td>199.997910</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">9</td>
<td>neural cell</td>
<td>AML</td>
<td>79.843632</td>
<td>79.843632</td>
<td>61.290397</td>
<td>98.396868</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">10</td>
<td>neural cell</td>
<td>NBM</td>
<td>57.869702</td>
<td>49.944344</td>
<td>9.815320</td>
<td>187.956746</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">11</td>
<td>unknown cell</td>
<td>NBM</td>
<td>91.914579</td>
<td>87.038869</td>
<td>6.586107</td>
<td>199.984000</td>
</tr>
</tbody>
</table>

</div>

``` python
# Get top five and bottom five cell types with respect to mean distance in each unique region separately.
def get_top_bottom_cell_types_by_mean(df, cell_type_level, unique_region, top_n=5):
    # Filter the DataFrame for the specified unique region and cell type level
    df_filtered = df[df['Unique Region'] == unique_region]

    # Group by the specified cell type level and calculate mean distance
    df_grouped = df_filtered.groupby(cell_type_level).agg(mean_distance=('Distance', 'mean')).reset_index()
    
    # Sort by mean distance to get top and bottom cell types
    df_sorted = df_grouped.sort_values(by='mean_distance', ascending=False)
    
    # Get top N and bottom N cell types
    top_cell_types = df_sorted.head(top_n)
    bottom_cell_types = df_sorted.tail(top_n)
    
    return top_cell_types, bottom_cell_types

# Get top and bottom cell types for each unique region in the dataset.
unique_regions = df_all_edges_with_cell_type_level['Unique Region'].unique()
for region in unique_regions:
    top_bottom = get_top_bottom_cell_types_by_mean(df_all_edges_with_cell_type_level, cell_type_level, region)
    print(f"\nTop 5 cell types in {region}:")
    print(top_bottom[0])
    print(f"\nBottom 5 cell types in {region}:")
    print(top_bottom[1])
```


    Top 5 cell types in NSM:
                Level One Cell Type  mean_distance
    0  hematopoietic precursor cell      95.233485
    1                   immune cell      93.334766
    2              mesenchymal cell      79.140648

    Bottom 5 cell types in NSM:
                Level One Cell Type  mean_distance
    0  hematopoietic precursor cell      95.233485
    1                   immune cell      93.334766
    2              mesenchymal cell      79.140648

    Top 5 cell types in AML:
                Level One Cell Type  mean_distance
    3                   neural cell      79.843632
    0  hematopoietic precursor cell      75.807458
    1                   immune cell      72.244373
    2              mesenchymal cell      68.072424

    Bottom 5 cell types in AML:
                Level One Cell Type  mean_distance
    3                   neural cell      79.843632
    0  hematopoietic precursor cell      75.807458
    1                   immune cell      72.244373
    2              mesenchymal cell      68.072424

    Top 5 cell types in NBM:
                Level One Cell Type  mean_distance
    4                  unknown cell      91.914579
    0  hematopoietic precursor cell      91.437465
    1                   immune cell      89.656605
    2              mesenchymal cell      82.079626
    3                   neural cell      57.869702

    Bottom 5 cell types in NBM:
                Level One Cell Type  mean_distance
    4                  unknown cell      91.914579
    0  hematopoietic precursor cell      91.437465
    1                   immune cell      89.656605
    2              mesenchymal cell      82.079626
    3                   neural cell      57.869702

``` python
# Get top five and bottom five cell types with respect to median distance in each unique region separately.
def get_top_bottom_cell_types_by_median(df, cell_type_level, unique_region, top_n=5):
    # Filter the DataFrame for the specified unique region and cell type level
    df_filtered = df[df['Unique Region'] == unique_region]

    # Group by the specified cell type level and calculate median distance
    df_grouped = df_filtered.groupby(cell_type_level).agg(median_distance=('Distance', 'median')).reset_index()

    # Sort by median distance to get top and bottom cell types
    df_sorted = df_grouped.sort_values(by='median_distance', ascending=False)

    # Get top N and bottom N cell types
    top_cell_types = df_sorted.head(top_n)
    bottom_cell_types = df_sorted.tail(top_n)
    
    return top_cell_types, bottom_cell_types

# Get top and bottom cell types for each unique region in the dataset.
unique_regions = df_all_edges_with_cell_type_level['Unique Region'].unique()
for region in unique_regions:
    top_bottom = get_top_bottom_cell_types_by_median(df_all_edges_with_cell_type_level, cell_type_level, region)
    print(f"\nTop 5 cell types in {region}:")
    print(top_bottom[0])
    print(f"\nBottom 5 cell types in {region}:")
    print(top_bottom[1])
```


    Top 5 cell types in NSM:
                Level One Cell Type  median_distance
    0  hematopoietic precursor cell        89.641506
    1                   immune cell        87.175896
    2              mesenchymal cell        69.671854

    Bottom 5 cell types in NSM:
                Level One Cell Type  median_distance
    0  hematopoietic precursor cell        89.641506
    1                   immune cell        87.175896
    2              mesenchymal cell        69.671854

    Top 5 cell types in AML:
                Level One Cell Type  median_distance
    3                   neural cell        79.843632
    0  hematopoietic precursor cell        68.350787
    1                   immune cell        64.713204
    2              mesenchymal cell        59.045392

    Bottom 5 cell types in AML:
                Level One Cell Type  median_distance
    3                   neural cell        79.843632
    0  hematopoietic precursor cell        68.350787
    1                   immune cell        64.713204
    2              mesenchymal cell        59.045392

    Top 5 cell types in NBM:
                Level One Cell Type  median_distance
    4                  unknown cell        87.038869
    0  hematopoietic precursor cell        86.347062
    1                   immune cell        84.596595
    2              mesenchymal cell        75.429180
    3                   neural cell        49.944344

    Bottom 5 cell types in NBM:
                Level One Cell Type  median_distance
    4                  unknown cell        87.038869
    0  hematopoietic precursor cell        86.347062
    1                   immune cell        84.596595
    2              mesenchymal cell        75.429180
    3                   neural cell        49.944344

``` python
# Calculate regional variability
def calculate_regional_variability(df_all_edges_with_cell_type_level, cell_type_level):
    """    Calculate regional variability for distances in the given DataFrame.
    """
    regional_variability = df_all_edges_with_cell_type_level.groupby('Unique Region')['Distance'].agg([
        ('mean', 'mean'),
        ('std', 'std')
    ]).round(2)

    # Add CV as percentage
    regional_variability['CV (%)'] = (regional_variability['std'] / regional_variability['mean'] * 100).round(1)

    print("\nRegional Variability Analysis:")
    print("Mean: Average distance in each region")
    print("Std: Standard deviation of distances")
    print("CV: Coefficient of Variation (std/mean * 100%)")
    print(regional_variability)

    # Calculate variability for each cell type
    cell_type_variability = df_all_edges_with_cell_type_level.groupby(cell_type_level)['Distance'].agg([
        ('mean', 'mean'),
        ('std', 'std')
    ]).round(2)

    # Add CV as percentage
    cell_type_variability['CV (%)'] = (cell_type_variability['std'] / cell_type_variability['mean'] * 100).round(1)

    print("\nCell Type Variability Analysis (sorted by CV):")
    print(cell_type_variability.sort_values('CV (%)', ascending=False))

calculate_regional_variability(df_all_edges_with_cell_type_level, cell_type_level)
```


    Regional Variability Analysis:
    Mean: Average distance in each region
    Std: Standard deviation of distances
    CV: Coefficient of Variation (std/mean * 100%)
                    mean    std  CV (%)
    Unique Region                      
    AML            74.38  42.82    57.6
    NBM            90.32  48.07    53.2
    NSM            93.84  50.99    54.3

    Cell Type Variability Analysis (sorted by CV):
                                   mean    std  CV (%)
    Level One Cell Type                               
    neural cell                   58.71  38.97    66.4
    mesenchymal cell              79.84  49.34    61.8
    immune cell                   88.12  48.41    54.9
    hematopoietic precursor cell  88.63  47.43    53.5
    unknown cell                  91.91  48.28    52.5

``` python
# Define the standard region sequence for plots
regions = ['NBM', 'AML', 'NSM']
```

``` python
# Generate Violin Plot
def plot_violin_cells_per_celltype(df_all_edges_with_cell_type_level, cell_type_level, output_dir, density_norm='area'):
    sns.set_style("whitegrid")
    sns.set_context("notebook", rc={"grid.linewidth": 2})
    plt.figure(figsize=(10, 6))
    plt.rcParams["svg.fonttype"] = 'none'  # to store text as text, not as path

    sns.violinplot(data=df_all_edges_with_cell_type_level, x=cell_type_level, y="Distance", density_norm=density_norm, common_norm=True, cut=0, inner="box", split=False, palette='Spectral', alpha=.9)

    sns.set_theme(style="whitegrid")
    sns.set_context("paper")


    font_size = 10
    plt.legend(fontsize=font_size)

    plt.title(f'Violin Plot of distances by {cell_type_level} (Density Normalization: {density_norm})', fontsize=font_size)

    plt.xlabel(f'{cell_type_level}', fontsize=font_size)
    plt.ylabel('Distance (\u03bcm)', fontsize=font_size)

    # Increase font size for all text in the figure
    plt.xticks(fontsize=font_size)
    plt.xticks(rotation=90)
    plt.yticks(fontsize=font_size)

    plt.tight_layout()

    plt.savefig(os.path.join(output_dir, f'{dataset_dir}_violin_cells_per_celltype_{cell_type_level}.png'), dpi=300,
                bbox_inches='tight',
                pad_inches=0.5)
    plt.savefig(os.path.join(output_dir, f'{dataset_dir}_violin_cells_per_celltype_{cell_type_level}.svg'), dpi=300,
                bbox_inches='tight',
                pad_inches=0.5)
    plt.show()

plot_violin_cells_per_celltype(df_all_edges_with_cell_type_level, cell_type_level, os.path.join(basepath, figures_output_dir), density_norm='area')
```

![](09_distance_analysis__bonemarrow-codex-chop_files/figure-commonmark/cell-31-output-1.png)

``` python
# Boxplots of distribution of distances by cell type and region.
def plot_distance_distribution_boxplots_by_region(df_all_edges_with_cell_type_level, cell_type_level, output_dir):
    plt.figure(figsize=(16, 8))
    plt.rcParams["svg.fonttype"] = 'none'  # to store text as text, not as path
    # Create categorical type with only the regions that exist in the data
    available_regions = [r for r in regions if r in df_all_edges_with_cell_type_level['Unique Region'].unique()]
    df_all_edges_with_cell_type_level['Unique Region'] = pd.Categorical(
        df_all_edges_with_cell_type_level['Unique Region'],
        categories=available_regions,
        ordered=True
    )

    # Make box plot.
    sns.boxplot(data=df_all_edges_with_cell_type_level, x=cell_type_level, y='Distance', hue='Unique Region', showfliers=False, palette='Spectral') # viridis or Spectral palette for better color distinction
    font_size = 10
    plt.xticks(rotation=90, ha='right', fontsize=font_size)
    plt.yticks(fontsize=font_size)
    plt.title(f'Distribution of distances by {cell_type_level} and region', fontsize=font_size)
    plt.xlabel(f'{cell_type_level}', fontsize=font_size)
    plt.ylabel('Distance (\u03bcm)', fontsize=font_size)
    plt.legend(bbox_to_anchor=(1, 1), loc='upper left')
    plt.tight_layout()

    plt.savefig(os.path.join(output_dir, f'{dataset_dir}_distance_distribution_boxplots_by_region_{cell_type_level}.png'), dpi=300,
                    bbox_inches='tight',
                    pad_inches=0.5)
    plt.savefig(os.path.join(output_dir, f'{dataset_dir}_distance_distribution_boxplots_by_region_{cell_type_level}.svg'), dpi=300,
                    bbox_inches='tight',
                    pad_inches=0.5)
    plt.show()

plot_distance_distribution_boxplots_by_region(df_all_edges_with_cell_type_level, cell_type_level, os.path.join(basepath, figures_output_dir))
```

![](09_distance_analysis__bonemarrow-codex-chop_files/figure-commonmark/cell-32-output-1.png)

``` python
# Boxplots of distribution of distances by cell type and region.
def plot_distance_distribution_heatmap(df_all_edges_with_cell_type_level, cell_type_level, output_dir):
    pivot_data = df_all_edges_with_cell_type_level.pivot_table(
    values='Distance',
    index=cell_type_level,
    columns='Unique Region',
    aggfunc='median'
    )

    plt.figure(figsize=(15, 10))
    plt.rcParams["svg.fonttype"] = 'none'  # to store text as text, not as path
    sns.heatmap(pivot_data, annot=True, fmt='.1f', cmap='Spectral')
    plt.title(f'Heatmap of median distances by {cell_type_level}', fontsize=12)

    font_size = 10
    plt.xticks(rotation=90, ha='right', fontsize=font_size)
    plt.yticks(fontsize=font_size)

    plt.xlabel('Unique Region', fontsize=font_size)
    plt.ylabel(f'{cell_type_level}', fontsize=font_size)
    
    plt.tight_layout()

    plt.savefig(os.path.join(output_dir, f'{dataset_dir}_distance_distribution_heatmap_{cell_type_level}.png'), dpi=300,
                    bbox_inches='tight',
                    pad_inches=0.5)
    plt.savefig(os.path.join(output_dir, f'{dataset_dir}_distance_distribution_heatmap_{cell_type_level}.svg'), dpi=300,
                    bbox_inches='tight',
                    pad_inches=0.5)
    plt.show()

plot_distance_distribution_heatmap(df_all_edges_with_cell_type_level, cell_type_level, os.path.join(basepath, figures_output_dir))
```

![](09_distance_analysis__bonemarrow-codex-chop_files/figure-commonmark/cell-33-output-1.png)

``` python
# Generate Violin Plot per unique region in both small intestine and large intestine. Create for all 8 regions as 8 subplots.
def plot_violin_plots_all_regions(df_all_edges_with_cell_type_level, cell_type_level, output_dir, density_norm="area"):
    sns.set_style("whitegrid")
    sns.set_context("notebook", rc={"grid.linewidth": 1})
    plt.rcParams["svg.fonttype"] = 'none'  # to store text as text, not as path
    font_size = 10
    fig, axs = plt.subplots(3, 1, figsize=(10, 15)) # Adjusted figsize for horizontal layout
    fig.suptitle(f'Distance distribution per {cell_type_level} in `{dataset_dir}` (density normalization = {density_norm})', fontsize=font_size, y=1)

    # Keep the sequence of Cell Types consistent across plots.
    cell_types = sorted(df_all_edges_with_cell_type_level[cell_type_level].unique())

    # Create a color palette based on the number of unique classes
    color_palette = sns.color_palette("Spectral", n_colors=len(cell_types))

    # Create a dictionary mapping class to color
    class_color_dict = dict(zip(cell_types, color_palette))

    for i, region in enumerate(regions):
        data_reg = df_all_edges_with_cell_type_level[df_all_edges_with_cell_type_level['Unique Region'] == region]
        sns.violinplot(data=data_reg, x=cell_type_level, y="Distance", density_norm=density_norm, common_norm=True, cut=0, inner="box", split=False, palette=class_color_dict, alpha=.9, ax=axs[i], hue=cell_type_level, legend=False, order=cell_types, fill=True)
        axs[i].set_title(region, fontsize=font_size)
        axs[i].set_xlabel('', fontsize=font_size)
        axs[i].set_ylabel('Distance (\u03bcm)', fontsize=font_size)
        # axs[i].tick_params(axis='x', labelrotation=90, labelsize=font_size)
        # only show xtick labels for the last subplot
        if i < len(regions) - 1:
            axs[i].set_xticklabels([])
        else:
            axs[i].set_xticklabels(cell_types, fontsize=font_size, rotation=90, ha='right')
        # axs[i].set_ylim(0, data_reg['Distance'].max() * 1.1)  # Set y-limits to be consistent across all plots
        axs[i].tick_params(axis='both', labelsize=font_size)

    # Use fig.text for precise label positioning
    fig.figure.text(0.5, -0.02, f'{cell_type_level}', ha='center', va='bottom', fontsize=font_size)

    plt.tight_layout()

    plt.savefig(os.path.join(output_dir, f'{dataset_dir}_violin_plots_all_regions_{cell_type_level}.png'), dpi=300,
                    bbox_inches='tight',
                    pad_inches=0.5)
    plt.savefig(os.path.join(output_dir, f'{dataset_dir}_violin_plots_all_regions_{cell_type_level}.svg'), dpi=300,
                    bbox_inches='tight',
                    pad_inches=0.5)
    
    plt.show()

plot_violin_plots_all_regions(df_all_edges_with_cell_type_level, cell_type_level, os.path.join(basepath, figures_output_dir), density_norm="count") # density_norm="count" or "area" can be used based on preference.
```

![](09_distance_analysis__bonemarrow-codex-chop_files/figure-commonmark/cell-34-output-1.png)

### Level Two Cell Type Analysis

``` python
# Get mean, median, minimum, maximum distance per cell type in all unique regions.
cell_type_level = 'Level Two Cell Type'
df_all_edges_with_cell_type_level = df_all_edges_with_cell_types[(df_all_edges_with_cell_types['Anchor Cell Type Level'] == cell_type_level) & (df_all_edges_with_cell_types['Anchor Cell Type'] == anchor_cell_type_dict[cell_type_level])]

df_distance_stats_cell_type_level = df_all_edges_with_cell_type_level.groupby([cell_type_level, 'Unique Region']).agg(
    mean_distance=('Distance', 'mean'),
    median_distance=('Distance', 'median'),
    min_distance=('Distance', 'min'),
    max_distance=('Distance', 'max')
).reset_index()
df_distance_stats_cell_type_level
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&#10;    .dataframe tbody tr th {
        vertical-align: top;
    }
&#10;    .dataframe thead th {
        text-align: right;
    }
</style>

<table class="dataframe" data-quarto-postprocess="true" data-border="1">
<thead>
<tr style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Level Two Cell Type</th>
<th data-quarto-table-cell-role="th">Unique Region</th>
<th data-quarto-table-cell-role="th">mean_distance</th>
<th data-quarto-table-cell-role="th">median_distance</th>
<th data-quarto-table-cell-role="th">min_distance</th>
<th data-quarto-table-cell-role="th">max_distance</th>
</tr>
</thead>
<tbody>
<tr>
<td data-quarto-table-cell-role="th">0</td>
<td>abnormal cell</td>
<td>AML</td>
<td>84.612826</td>
<td>78.755366</td>
<td>7.350124</td>
<td>199.982016</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">1</td>
<td>adipocyte</td>
<td>AML</td>
<td>72.044065</td>
<td>61.569803</td>
<td>9.299294</td>
<td>198.520789</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">2</td>
<td>adipocyte</td>
<td>NBM</td>
<td>92.656243</td>
<td>88.435461</td>
<td>8.040248</td>
<td>199.992343</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">3</td>
<td>adipocyte</td>
<td>NSM</td>
<td>84.007363</td>
<td>76.639037</td>
<td>8.344688</td>
<td>199.997910</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">4</td>
<td>b cell</td>
<td>AML</td>
<td>78.392682</td>
<td>71.243188</td>
<td>9.244128</td>
<td>199.966621</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">5</td>
<td>b cell</td>
<td>NBM</td>
<td>97.615652</td>
<td>95.012793</td>
<td>8.025751</td>
<td>199.996640</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">6</td>
<td>b cell</td>
<td>NSM</td>
<td>96.232882</td>
<td>91.578635</td>
<td>9.240345</td>
<td>199.991504</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">7</td>
<td>dendritic cell</td>
<td>AML</td>
<td>79.071847</td>
<td>72.219946</td>
<td>9.452268</td>
<td>199.541677</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">8</td>
<td>dendritic cell</td>
<td>NBM</td>
<td>94.921339</td>
<td>90.375897</td>
<td>8.032959</td>
<td>199.978479</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">9</td>
<td>dendritic cell</td>
<td>NSM</td>
<td>96.121120</td>
<td>90.482325</td>
<td>10.456776</td>
<td>199.356229</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">10</td>
<td>endothelial cell of artery</td>
<td>AML</td>
<td>66.552461</td>
<td>57.188080</td>
<td>9.598652</td>
<td>197.775548</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">11</td>
<td>endothelial cell of artery</td>
<td>NBM</td>
<td>80.875474</td>
<td>71.598061</td>
<td>7.165130</td>
<td>199.696671</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">12</td>
<td>endothelial cell of artery</td>
<td>NSM</td>
<td>65.333875</td>
<td>55.348929</td>
<td>8.340683</td>
<td>199.496217</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">13</td>
<td>erythroid precursor</td>
<td>AML</td>
<td>75.974098</td>
<td>67.872764</td>
<td>7.687746</td>
<td>199.911019</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">14</td>
<td>erythroid precursor</td>
<td>NBM</td>
<td>95.055450</td>
<td>90.578380</td>
<td>7.368943</td>
<td>199.990928</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">15</td>
<td>erythroid precursor</td>
<td>NSM</td>
<td>97.332711</td>
<td>92.296305</td>
<td>8.124669</td>
<td>199.985663</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">16</td>
<td>hematopoietic stem and progenitor cell</td>
<td>AML</td>
<td>54.563528</td>
<td>37.139774</td>
<td>9.123395</td>
<td>189.847535</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">17</td>
<td>hematopoietic stem and progenitor cell</td>
<td>NBM</td>
<td>95.280715</td>
<td>93.347852</td>
<td>9.670863</td>
<td>199.738928</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">18</td>
<td>hematopoietic stem and progenitor cell</td>
<td>NSM</td>
<td>104.959083</td>
<td>98.965058</td>
<td>13.524865</td>
<td>196.588555</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">19</td>
<td>macrophage</td>
<td>AML</td>
<td>73.826747</td>
<td>67.164529</td>
<td>9.347675</td>
<td>198.307993</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">20</td>
<td>macrophage</td>
<td>NBM</td>
<td>96.799495</td>
<td>91.931956</td>
<td>8.152219</td>
<td>199.997797</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">21</td>
<td>macrophage</td>
<td>NSM</td>
<td>90.324484</td>
<td>82.094705</td>
<td>9.073456</td>
<td>199.512374</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">22</td>
<td>megakaryocyte</td>
<td>AML</td>
<td>77.991861</td>
<td>68.126728</td>
<td>9.953335</td>
<td>199.430617</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">23</td>
<td>megakaryocyte</td>
<td>NBM</td>
<td>98.795997</td>
<td>94.345559</td>
<td>8.774989</td>
<td>199.937106</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">24</td>
<td>megakaryocyte</td>
<td>NSM</td>
<td>98.796581</td>
<td>92.705512</td>
<td>12.087462</td>
<td>199.884221</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">25</td>
<td>mesenchymal stem cell</td>
<td>AML</td>
<td>78.724108</td>
<td>71.696786</td>
<td>8.585049</td>
<td>198.703670</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">26</td>
<td>mesenchymal stem cell</td>
<td>NBM</td>
<td>91.666993</td>
<td>87.259370</td>
<td>9.507509</td>
<td>199.986823</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">27</td>
<td>mesenchymal stem cell</td>
<td>NSM</td>
<td>87.206186</td>
<td>83.498779</td>
<td>9.652741</td>
<td>199.570947</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">28</td>
<td>mesenchymal stem/stromal cell</td>
<td>AML</td>
<td>75.223250</td>
<td>65.025012</td>
<td>10.898685</td>
<td>199.967713</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">29</td>
<td>mesenchymal stem/stromal cell</td>
<td>NBM</td>
<td>91.820716</td>
<td>86.924087</td>
<td>7.572935</td>
<td>199.852192</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">30</td>
<td>mesenchymal stem/stromal cell</td>
<td>NSM</td>
<td>91.464706</td>
<td>80.083330</td>
<td>10.301344</td>
<td>199.472893</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">31</td>
<td>monocyte</td>
<td>AML</td>
<td>82.273906</td>
<td>76.137286</td>
<td>8.868460</td>
<td>199.876784</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">32</td>
<td>monocyte</td>
<td>NBM</td>
<td>91.519407</td>
<td>86.756461</td>
<td>7.351953</td>
<td>199.985575</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">33</td>
<td>monocyte</td>
<td>NSM</td>
<td>92.240440</td>
<td>85.765454</td>
<td>8.268363</td>
<td>199.934336</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">34</td>
<td>muscle cell</td>
<td>AML</td>
<td>69.735721</td>
<td>59.183423</td>
<td>10.271701</td>
<td>194.082988</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">35</td>
<td>muscle cell</td>
<td>NBM</td>
<td>94.216885</td>
<td>87.575318</td>
<td>9.427550</td>
<td>199.834792</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">36</td>
<td>muscle cell</td>
<td>NSM</td>
<td>55.313443</td>
<td>46.465657</td>
<td>10.248018</td>
<td>198.935026</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">37</td>
<td>myeloid cell</td>
<td>AML</td>
<td>76.635516</td>
<td>68.660555</td>
<td>8.373370</td>
<td>199.748940</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">38</td>
<td>myeloid cell</td>
<td>NBM</td>
<td>93.908272</td>
<td>89.618397</td>
<td>7.514845</td>
<td>199.998770</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">39</td>
<td>myeloid cell</td>
<td>NSM</td>
<td>95.283475</td>
<td>89.390289</td>
<td>7.675593</td>
<td>199.984961</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">40</td>
<td>myeloid precursor</td>
<td>AML</td>
<td>80.963771</td>
<td>73.387438</td>
<td>8.604672</td>
<td>199.919874</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">41</td>
<td>myeloid precursor</td>
<td>NBM</td>
<td>96.919348</td>
<td>93.418496</td>
<td>7.505009</td>
<td>199.999142</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">42</td>
<td>myeloid precursor</td>
<td>NSM</td>
<td>97.037575</td>
<td>92.060765</td>
<td>8.173025</td>
<td>199.969054</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">43</td>
<td>neuroglial cell</td>
<td>AML</td>
<td>128.321993</td>
<td>128.321993</td>
<td>128.321993</td>
<td>128.321993</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">44</td>
<td>neuroglial cell</td>
<td>NBM</td>
<td>86.411262</td>
<td>78.933059</td>
<td>17.934662</td>
<td>175.871271</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">45</td>
<td>progenitor cell</td>
<td>AML</td>
<td>78.395834</td>
<td>70.509229</td>
<td>6.056625</td>
<td>199.797032</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">46</td>
<td>progenitor cell</td>
<td>NBM</td>
<td>98.953368</td>
<td>96.413601</td>
<td>8.000469</td>
<td>199.988637</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">47</td>
<td>progenitor cell</td>
<td>NSM</td>
<td>97.117247</td>
<td>92.464861</td>
<td>9.423956</td>
<td>199.969595</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">48</td>
<td>skeletal stromal cell</td>
<td>AML</td>
<td>78.238144</td>
<td>65.728809</td>
<td>13.246899</td>
<td>195.060591</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">49</td>
<td>skeletal stromal cell</td>
<td>NBM</td>
<td>94.062042</td>
<td>88.538574</td>
<td>8.954561</td>
<td>199.829571</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">50</td>
<td>skeletal stromal cell</td>
<td>NSM</td>
<td>89.169229</td>
<td>77.967966</td>
<td>11.309889</td>
<td>198.710354</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">51</td>
<td>stem cell</td>
<td>AML</td>
<td>70.097786</td>
<td>59.523007</td>
<td>10.801688</td>
<td>193.191236</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">52</td>
<td>stem cell</td>
<td>NBM</td>
<td>96.060575</td>
<td>92.318654</td>
<td>9.741716</td>
<td>199.970348</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">53</td>
<td>stem cell</td>
<td>NSM</td>
<td>92.740997</td>
<td>90.714633</td>
<td>8.036234</td>
<td>199.237795</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">54</td>
<td>t cell</td>
<td>AML</td>
<td>80.957774</td>
<td>73.440678</td>
<td>8.247845</td>
<td>199.988548</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">55</td>
<td>t cell</td>
<td>NBM</td>
<td>94.412441</td>
<td>90.318472</td>
<td>8.190426</td>
<td>199.995542</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">56</td>
<td>t cell</td>
<td>NSM</td>
<td>94.730211</td>
<td>88.963905</td>
<td>9.018322</td>
<td>199.997383</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">57</td>
<td>unknown cell</td>
<td>NBM</td>
<td>96.310960</td>
<td>92.693095</td>
<td>8.043118</td>
<td>199.984452</td>
</tr>
</tbody>
</table>

</div>

``` python
# Get top and bottom cell types for each unique region in the dataset.
unique_regions = df_all_edges_with_cell_type_level['Unique Region'].unique()
for region in unique_regions:
    top_bottom = get_top_bottom_cell_types_by_mean(df_all_edges_with_cell_type_level, cell_type_level, region)
    print(f"\nTop 5 cell types in {region}:")
    print(top_bottom[0])
    print(f"\nBottom 5 cell types in {region}:")
    print(top_bottom[1])
```


    Top 5 cell types in NSM:
                           Level Two Cell Type  mean_distance
    5   hematopoietic stem and progenitor cell     104.959083
    7                            megakaryocyte      98.796581
    4                     erythroid precursor       97.332711
    14                         progenitor cell      97.117247
    13                       myeloid precursor      97.037575

    Bottom 5 cell types in NSM:
               Level Two Cell Type  mean_distance
    15       skeletal stromal cell      89.169229
    8        mesenchymal stem cell      87.206186
    0                    adipocyte      84.007363
    3   endothelial cell of artery      65.333875
    11                 muscle cell      55.313443

    Top 5 cell types in AML:
       Level Two Cell Type  mean_distance
    15     neuroglial cell     128.321993
    0        abnormal cell      84.612826
    11            monocyte      82.273906
    14   myeloid precursor      80.963771
    19              t cell      80.957774

    Bottom 5 cell types in AML:
                           Level Two Cell Type  mean_distance
    1                                adipocyte      72.044065
    18                               stem cell      70.097786
    12                             muscle cell      69.735721
    4               endothelial cell of artery      66.552461
    6   hematopoietic stem and progenitor cell      54.563528

    Top 5 cell types in NBM:
       Level Two Cell Type  mean_distance
    15     progenitor cell      98.953368
    7        megakaryocyte      98.795997
    1               b cell      97.615652
    13   myeloid precursor      96.919348
    6           macrophage      96.799495

    Bottom 5 cell types in NBM:
                  Level Two Cell Type  mean_distance
    9   mesenchymal stem/stromal cell      91.820716
    8           mesenchymal stem cell      91.666993
    10                       monocyte      91.519407
    14                neuroglial cell      86.411262
    3      endothelial cell of artery      80.875474

``` python
# Get top and bottom cell types for each unique region in the dataset.
unique_regions = df_all_edges_with_cell_type_level['Unique Region'].unique()
for region in unique_regions:
    top_bottom = get_top_bottom_cell_types_by_median(df_all_edges_with_cell_type_level, cell_type_level, region)
    print(f"\nTop 5 cell types in {region}:")
    print(top_bottom[0])
    print(f"\nBottom 5 cell types in {region}:")
    print(top_bottom[1])
```


    Top 5 cell types in NSM:
                           Level Two Cell Type  median_distance
    5   hematopoietic stem and progenitor cell        98.965058
    7                            megakaryocyte        92.705512
    14                         progenitor cell        92.464861
    4                     erythroid precursor         92.296305
    13                       myeloid precursor        92.060765

    Bottom 5 cell types in NSM:
                  Level Two Cell Type  median_distance
    9   mesenchymal stem/stromal cell        80.083330
    15          skeletal stromal cell        77.967966
    0                       adipocyte        76.639037
    3      endothelial cell of artery        55.348929
    11                    muscle cell        46.465657

    Top 5 cell types in AML:
       Level Two Cell Type  median_distance
    15     neuroglial cell       128.321993
    0        abnormal cell        78.755366
    11            monocyte        76.137286
    19              t cell        73.440678
    14   myeloid precursor        73.387438

    Bottom 5 cell types in AML:
                           Level Two Cell Type  median_distance
    1                                adipocyte        61.569803
    18                               stem cell        59.523007
    12                             muscle cell        59.183423
    4               endothelial cell of artery        57.188080
    6   hematopoietic stem and progenitor cell        37.139774

    Top 5 cell types in NBM:
                           Level Two Cell Type  median_distance
    15                         progenitor cell        96.413601
    1                                   b cell        95.012793
    7                            megakaryocyte        94.345559
    13                       myeloid precursor        93.418496
    5   hematopoietic stem and progenitor cell        93.347852

    Bottom 5 cell types in NBM:
                  Level Two Cell Type  median_distance
    8           mesenchymal stem cell        87.259370
    9   mesenchymal stem/stromal cell        86.924087
    10                       monocyte        86.756461
    14                neuroglial cell        78.933059
    3      endothelial cell of artery        71.598061

``` python
calculate_regional_variability(df_all_edges_with_cell_type_level, cell_type_level)
```


    Regional Variability Analysis:
    Mean: Average distance in each region
    Std: Standard deviation of distances
    CV: Coefficient of Variation (std/mean * 100%)
                    mean    std  CV (%)
    Unique Region                      
    AML            79.39  44.80    56.4
    NBM            95.30  48.83    51.2
    NSM            95.64  51.03    53.4

    Cell Type Variability Analysis (sorted by CV):
                                             mean    std  CV (%)
    Level Two Cell Type                                         
    endothelial cell of artery              77.69  52.16    67.1
    muscle cell                             87.24  50.87    58.3
    skeletal stromal cell                   92.68  52.72    56.9
    adipocyte                               89.36  50.19    56.2
    monocyte                                89.60  49.68    55.4
    mesenchymal stem cell                   87.59  48.55    55.4
    mesenchymal stem/stromal cell           89.52  48.91    54.6
    dendritic cell                          89.61  48.91    54.6
    t cell                                  92.82  49.73    53.6
    hematopoietic stem and progenitor cell  93.87  49.72    53.0
    myeloid cell                            93.01  49.27    53.0
    abnormal cell                           84.61  44.08    52.1
    erythroid precursor                     92.48  48.09    52.0
    myeloid precursor                       94.87  49.06    51.7
    stem cell                               94.15  48.57    51.6
    macrophage                              92.25  47.60    51.6
    b cell                                  94.91  48.86    51.5
    progenitor cell                         95.58  49.02    51.3
    unknown cell                            96.31  48.92    50.8
    neuroglial cell                         87.43  43.59    49.9
    megakaryocyte                           94.69  47.09    49.7

``` python
plot_violin_cells_per_celltype(df_all_edges_with_cell_type_level, cell_type_level, os.path.join(basepath, figures_output_dir), density_norm='area')
```

![](09_distance_analysis__bonemarrow-codex-chop_files/figure-commonmark/cell-39-output-1.png)

``` python
plot_distance_distribution_boxplots_by_region(df_all_edges_with_cell_type_level, cell_type_level, os.path.join(basepath, figures_output_dir))
```

![](09_distance_analysis__bonemarrow-codex-chop_files/figure-commonmark/cell-40-output-1.png)

``` python
plot_distance_distribution_heatmap(df_all_edges_with_cell_type_level, cell_type_level, os.path.join(basepath, figures_output_dir))
```

![](09_distance_analysis__bonemarrow-codex-chop_files/figure-commonmark/cell-41-output-1.png)

``` python
plot_violin_plots_all_regions(df_all_edges_with_cell_type_level, cell_type_level, os.path.join(basepath, figures_output_dir), density_norm="count") # Or, density_norm="count" or "area" based on preference.
```

![](09_distance_analysis__bonemarrow-codex-chop_files/figure-commonmark/cell-42-output-1.png)

### Level Three Cell Type Analysis

``` python
# Get mean, median, minimum, maximum distance per cell type in all unique regions.
cell_type_level = 'Level Three Cell Type'
df_all_edges_with_cell_type_level = df_all_edges_with_cell_types[(df_all_edges_with_cell_types['Anchor Cell Type Level'] == cell_type_level) & (df_all_edges_with_cell_types['Anchor Cell Type'] == anchor_cell_type_dict[cell_type_level])]

df_distance_stats_cell_type_level = df_all_edges_with_cell_type_level.groupby([cell_type_level, 'Unique Region']).agg(
    mean_distance=('Distance', 'mean'),
    median_distance=('Distance', 'median'),
    min_distance=('Distance', 'min'),
    max_distance=('Distance', 'max')
).reset_index()
df_distance_stats_cell_type_level
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&#10;    .dataframe tbody tr th {
        vertical-align: top;
    }
&#10;    .dataframe thead th {
        text-align: right;
    }
</style>

<table class="dataframe" data-quarto-postprocess="true" data-border="1">
<thead>
<tr style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Level Three Cell Type</th>
<th data-quarto-table-cell-role="th">Unique Region</th>
<th data-quarto-table-cell-role="th">mean_distance</th>
<th data-quarto-table-cell-role="th">median_distance</th>
<th data-quarto-table-cell-role="th">min_distance</th>
<th data-quarto-table-cell-role="th">max_distance</th>
</tr>
</thead>
<tbody>
<tr>
<td data-quarto-table-cell-role="th">0</td>
<td>adipocyte</td>
<td>AML</td>
<td>72.044065</td>
<td>61.569803</td>
<td>9.299294</td>
<td>198.520789</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">1</td>
<td>adipocyte</td>
<td>NBM</td>
<td>92.656243</td>
<td>88.435461</td>
<td>8.040248</td>
<td>199.992343</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">2</td>
<td>adipocyte</td>
<td>NSM</td>
<td>84.007363</td>
<td>76.639037</td>
<td>8.344688</td>
<td>199.997910</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">3</td>
<td>b cell</td>
<td>AML</td>
<td>76.143453</td>
<td>68.752778</td>
<td>9.244128</td>
<td>199.966621</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">4</td>
<td>b cell</td>
<td>NBM</td>
<td>96.138631</td>
<td>92.508923</td>
<td>8.025751</td>
<td>199.972480</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">5</td>
<td>b cell</td>
<td>NSM</td>
<td>94.707460</td>
<td>89.148689</td>
<td>9.240345</td>
<td>199.991504</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">6</td>
<td>b cell:immature</td>
<td>AML</td>
<td>82.461384</td>
<td>75.703532</td>
<td>10.072227</td>
<td>199.483659</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">7</td>
<td>b cell:immature</td>
<td>NBM</td>
<td>99.501175</td>
<td>96.731118</td>
<td>8.874948</td>
<td>199.954603</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">8</td>
<td>b cell:immature</td>
<td>NSM</td>
<td>97.478212</td>
<td>92.747527</td>
<td>9.555029</td>
<td>199.569086</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">9</td>
<td>cell:cd34+ cd61+</td>
<td>AML</td>
<td>74.287460</td>
<td>57.285741</td>
<td>11.620897</td>
<td>170.297284</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">10</td>
<td>cell:cd34+ cd61+</td>
<td>NBM</td>
<td>97.082979</td>
<td>99.005114</td>
<td>9.337088</td>
<td>198.401642</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">11</td>
<td>cell:cd34+ cd61+</td>
<td>NSM</td>
<td>54.635086</td>
<td>52.248486</td>
<td>48.701567</td>
<td>67.252810</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">12</td>
<td>dendritic cell:plasmacytoid</td>
<td>AML</td>
<td>79.071847</td>
<td>72.219946</td>
<td>9.452268</td>
<td>199.541677</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">13</td>
<td>dendritic cell:plasmacytoid</td>
<td>NBM</td>
<td>94.921339</td>
<td>90.375897</td>
<td>8.032959</td>
<td>199.978479</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">14</td>
<td>dendritic cell:plasmacytoid</td>
<td>NSM</td>
<td>96.121120</td>
<td>90.482325</td>
<td>10.456776</td>
<td>199.356229</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">15</td>
<td>endosteal cell</td>
<td>AML</td>
<td>78.238144</td>
<td>65.728809</td>
<td>13.246899</td>
<td>195.060591</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">16</td>
<td>endosteal cell</td>
<td>NBM</td>
<td>94.062042</td>
<td>88.538574</td>
<td>8.954561</td>
<td>199.829571</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">17</td>
<td>endosteal cell</td>
<td>NSM</td>
<td>89.169229</td>
<td>77.967966</td>
<td>11.309889</td>
<td>198.710354</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">18</td>
<td>endothelial cell of artery</td>
<td>AML</td>
<td>66.552461</td>
<td>57.188080</td>
<td>9.598652</td>
<td>197.775548</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">19</td>
<td>endothelial cell of artery</td>
<td>NBM</td>
<td>80.875474</td>
<td>71.598061</td>
<td>7.165130</td>
<td>199.696671</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">20</td>
<td>endothelial cell of artery</td>
<td>NSM</td>
<td>65.333875</td>
<td>55.348929</td>
<td>8.340683</td>
<td>199.496217</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">21</td>
<td>erythroblast</td>
<td>AML</td>
<td>74.204032</td>
<td>67.595458</td>
<td>9.345520</td>
<td>199.710488</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">22</td>
<td>erythroblast</td>
<td>NBM</td>
<td>97.493233</td>
<td>93.445013</td>
<td>9.438919</td>
<td>199.976653</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">23</td>
<td>erythroblast</td>
<td>NSM</td>
<td>99.975515</td>
<td>94.923044</td>
<td>10.526460</td>
<td>199.917168</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">24</td>
<td>erythroblast:basophilic</td>
<td>AML</td>
<td>52.951975</td>
<td>49.722590</td>
<td>12.385871</td>
<td>159.571485</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">25</td>
<td>erythroblast:basophilic</td>
<td>NBM</td>
<td>93.121025</td>
<td>93.171093</td>
<td>9.946056</td>
<td>199.013021</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">26</td>
<td>erythroblast:basophilic</td>
<td>NSM</td>
<td>69.175800</td>
<td>50.068324</td>
<td>21.363562</td>
<td>131.777261</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">27</td>
<td>erythroid lineage cell</td>
<td>AML</td>
<td>76.378711</td>
<td>67.967844</td>
<td>7.687746</td>
<td>199.911019</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">28</td>
<td>erythroid lineage cell</td>
<td>NBM</td>
<td>94.931105</td>
<td>90.427830</td>
<td>7.368943</td>
<td>199.990928</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">29</td>
<td>erythroid lineage cell</td>
<td>NSM</td>
<td>96.871888</td>
<td>91.762574</td>
<td>8.124669</td>
<td>199.985663</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">30</td>
<td>granulocyte monocyte progenitor cell</td>
<td>AML</td>
<td>70.212475</td>
<td>62.399469</td>
<td>8.821407</td>
<td>193.766544</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">31</td>
<td>granulocyte monocyte progenitor cell</td>
<td>NBM</td>
<td>99.994036</td>
<td>96.974877</td>
<td>10.086847</td>
<td>199.377339</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">32</td>
<td>granulocyte monocyte progenitor cell</td>
<td>NSM</td>
<td>113.471237</td>
<td>118.935939</td>
<td>24.621301</td>
<td>195.612217</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">33</td>
<td>granulocyte monocyte progenitor cell/myeloblast</td>
<td>AML</td>
<td>72.415964</td>
<td>63.423578</td>
<td>10.196329</td>
<td>190.981269</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">34</td>
<td>granulocyte monocyte progenitor cell/myeloblast</td>
<td>NBM</td>
<td>96.890873</td>
<td>95.757879</td>
<td>10.523154</td>
<td>199.686919</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">35</td>
<td>granulocyte monocyte progenitor cell/myeloblast</td>
<td>NSM</td>
<td>94.198042</td>
<td>90.199936</td>
<td>12.603882</td>
<td>198.890799</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">36</td>
<td>hematopoietic stem and progenitor cell:spink2+</td>
<td>AML</td>
<td>54.563528</td>
<td>37.139774</td>
<td>9.123395</td>
<td>189.847535</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">37</td>
<td>hematopoietic stem and progenitor cell:spink2+</td>
<td>NBM</td>
<td>95.280715</td>
<td>93.347852</td>
<td>9.670863</td>
<td>199.738928</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">38</td>
<td>hematopoietic stem and progenitor cell:spink2+</td>
<td>NSM</td>
<td>104.959083</td>
<td>98.965058</td>
<td>13.524865</td>
<td>196.588555</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">39</td>
<td>hematopoietic stem cell</td>
<td>AML</td>
<td>70.097786</td>
<td>59.523007</td>
<td>10.801688</td>
<td>193.191236</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">40</td>
<td>hematopoietic stem cell</td>
<td>NBM</td>
<td>96.060575</td>
<td>92.318654</td>
<td>9.741716</td>
<td>199.970348</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">41</td>
<td>hematopoietic stem cell</td>
<td>NSM</td>
<td>92.740997</td>
<td>90.714633</td>
<td>8.036234</td>
<td>199.237795</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">42</td>
<td>lymphoid progenitor cell:common</td>
<td>AML</td>
<td>70.369095</td>
<td>33.321110</td>
<td>11.891835</td>
<td>184.838570</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">43</td>
<td>lymphoid progenitor cell:common</td>
<td>NBM</td>
<td>101.297912</td>
<td>103.775147</td>
<td>8.703396</td>
<td>198.679098</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">44</td>
<td>lymphoid progenitor cell:common</td>
<td>NSM</td>
<td>48.644547</td>
<td>48.644547</td>
<td>40.392837</td>
<td>56.896257</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">45</td>
<td>macrophage</td>
<td>AML</td>
<td>73.826747</td>
<td>67.164529</td>
<td>9.347675</td>
<td>198.307993</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">46</td>
<td>macrophage</td>
<td>NBM</td>
<td>96.799495</td>
<td>91.931956</td>
<td>8.152219</td>
<td>199.997797</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">47</td>
<td>macrophage</td>
<td>NSM</td>
<td>90.324484</td>
<td>82.094705</td>
<td>9.073456</td>
<td>199.512374</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">48</td>
<td>megakaryocyte:gata1+</td>
<td>AML</td>
<td>76.859027</td>
<td>67.759673</td>
<td>11.187479</td>
<td>199.345585</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">49</td>
<td>megakaryocyte:gata1+</td>
<td>NBM</td>
<td>96.565594</td>
<td>89.912296</td>
<td>15.171096</td>
<td>199.835750</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">50</td>
<td>megakaryocyte:gata1+</td>
<td>NSM</td>
<td>99.813171</td>
<td>94.046165</td>
<td>12.087462</td>
<td>199.884221</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">51</td>
<td>megakaryocyte:gata1-</td>
<td>AML</td>
<td>81.549157</td>
<td>71.445335</td>
<td>9.953335</td>
<td>199.430617</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">52</td>
<td>megakaryocyte:gata1-</td>
<td>NBM</td>
<td>99.683106</td>
<td>95.220876</td>
<td>8.774989</td>
<td>199.937106</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">53</td>
<td>megakaryocyte:gata1-</td>
<td>NSM</td>
<td>96.343558</td>
<td>87.702763</td>
<td>14.433768</td>
<td>198.666219</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">54</td>
<td>mesenchymal stem cell of adipose tissue</td>
<td>AML</td>
<td>78.724108</td>
<td>71.696786</td>
<td>8.585049</td>
<td>198.703670</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">55</td>
<td>mesenchymal stem cell of adipose tissue</td>
<td>NBM</td>
<td>91.666993</td>
<td>87.259370</td>
<td>9.507509</td>
<td>199.986823</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">56</td>
<td>mesenchymal stem cell of adipose tissue</td>
<td>NSM</td>
<td>87.206186</td>
<td>83.498779</td>
<td>9.652741</td>
<td>199.570947</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">57</td>
<td>mesenchymal stem/stromal cell:thy1+</td>
<td>AML</td>
<td>75.223250</td>
<td>65.025012</td>
<td>10.898685</td>
<td>199.967713</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">58</td>
<td>mesenchymal stem/stromal cell:thy1+</td>
<td>NBM</td>
<td>91.820716</td>
<td>86.924087</td>
<td>7.572935</td>
<td>199.852192</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">59</td>
<td>mesenchymal stem/stromal cell:thy1+</td>
<td>NSM</td>
<td>91.464706</td>
<td>80.083330</td>
<td>10.301344</td>
<td>199.472893</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">60</td>
<td>monocyte</td>
<td>AML</td>
<td>81.998821</td>
<td>75.975206</td>
<td>8.868460</td>
<td>199.876784</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">61</td>
<td>monocyte</td>
<td>NBM</td>
<td>91.803183</td>
<td>87.198437</td>
<td>7.351953</td>
<td>199.985575</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">62</td>
<td>monocyte</td>
<td>NSM</td>
<td>91.957353</td>
<td>85.202021</td>
<td>8.268363</td>
<td>199.934336</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">63</td>
<td>monocyte:non-classical</td>
<td>AML</td>
<td>84.404224</td>
<td>77.154945</td>
<td>10.042509</td>
<td>199.557398</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">64</td>
<td>monocyte:non-classical</td>
<td>NBM</td>
<td>89.394134</td>
<td>83.017617</td>
<td>8.634223</td>
<td>199.962583</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">65</td>
<td>monocyte:non-classical</td>
<td>NSM</td>
<td>94.928483</td>
<td>89.610892</td>
<td>10.244014</td>
<td>199.859496</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">66</td>
<td>muscle cell:smooth</td>
<td>AML</td>
<td>69.735721</td>
<td>59.183423</td>
<td>10.271701</td>
<td>194.082988</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">67</td>
<td>muscle cell:smooth</td>
<td>NBM</td>
<td>94.216885</td>
<td>87.575318</td>
<td>9.427550</td>
<td>199.834792</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">68</td>
<td>muscle cell:smooth</td>
<td>NSM</td>
<td>55.313443</td>
<td>46.465657</td>
<td>10.248018</td>
<td>198.935026</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">69</td>
<td>mutant blast:npm1</td>
<td>AML</td>
<td>84.612826</td>
<td>78.755366</td>
<td>7.350124</td>
<td>199.982016</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">70</td>
<td>myeloid cell:intermediate</td>
<td>AML</td>
<td>81.373170</td>
<td>73.925935</td>
<td>8.604672</td>
<td>199.919874</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">71</td>
<td>myeloid cell:intermediate</td>
<td>NBM</td>
<td>96.900964</td>
<td>93.360407</td>
<td>7.505009</td>
<td>199.999142</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">72</td>
<td>myeloid cell:intermediate</td>
<td>NSM</td>
<td>97.020277</td>
<td>92.018090</td>
<td>8.173025</td>
<td>199.969054</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">73</td>
<td>myeloid cell:mature</td>
<td>AML</td>
<td>76.635516</td>
<td>68.660555</td>
<td>8.373370</td>
<td>199.748940</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">74</td>
<td>myeloid cell:mature</td>
<td>NBM</td>
<td>93.908272</td>
<td>89.618397</td>
<td>7.514845</td>
<td>199.998770</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">75</td>
<td>myeloid cell:mature</td>
<td>NSM</td>
<td>95.283475</td>
<td>89.390289</td>
<td>7.675593</td>
<td>199.984961</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">76</td>
<td>myeloid progenitor cell:common</td>
<td>AML</td>
<td>78.406261</td>
<td>70.510293</td>
<td>6.056625</td>
<td>199.797032</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">77</td>
<td>myeloid progenitor cell:common</td>
<td>NBM</td>
<td>98.947282</td>
<td>96.400048</td>
<td>8.000469</td>
<td>199.988637</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">78</td>
<td>myeloid progenitor cell:common</td>
<td>NSM</td>
<td>97.127281</td>
<td>92.476823</td>
<td>9.423956</td>
<td>199.969595</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">79</td>
<td>plasma cell</td>
<td>AML</td>
<td>79.030258</td>
<td>71.973497</td>
<td>9.340869</td>
<td>199.876610</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">80</td>
<td>plasma cell</td>
<td>NBM</td>
<td>100.456866</td>
<td>99.888396</td>
<td>8.273445</td>
<td>199.996640</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">81</td>
<td>plasma cell</td>
<td>NSM</td>
<td>96.900720</td>
<td>93.114820</td>
<td>10.602960</td>
<td>199.657054</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">82</td>
<td>schwann cell</td>
<td>AML</td>
<td>128.321993</td>
<td>128.321993</td>
<td>128.321993</td>
<td>128.321993</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">83</td>
<td>schwann cell</td>
<td>NBM</td>
<td>86.411262</td>
<td>78.933059</td>
<td>17.934662</td>
<td>175.871271</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">84</td>
<td>t cell:cd4+ alpha-beta</td>
<td>AML</td>
<td>82.044430</td>
<td>74.457114</td>
<td>8.247845</td>
<td>199.988548</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">85</td>
<td>t cell:cd4+ alpha-beta</td>
<td>NBM</td>
<td>94.775404</td>
<td>90.768274</td>
<td>8.443550</td>
<td>199.987582</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">86</td>
<td>t cell:cd4+ alpha-beta</td>
<td>NSM</td>
<td>92.912509</td>
<td>87.549465</td>
<td>9.815604</td>
<td>199.997383</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">87</td>
<td>t cell:cd8+ alpha-beta regulatory</td>
<td>AML</td>
<td>78.082735</td>
<td>70.753019</td>
<td>10.387187</td>
<td>199.927831</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">88</td>
<td>t cell:cd8+ alpha-beta regulatory</td>
<td>NBM</td>
<td>93.990508</td>
<td>89.772743</td>
<td>8.190426</td>
<td>199.995542</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">89</td>
<td>t cell:cd8+ alpha-beta regulatory</td>
<td>NSM</td>
<td>95.344181</td>
<td>89.646218</td>
<td>9.018322</td>
<td>199.899349</td>
</tr>
<tr>
<td data-quarto-table-cell-role="th">90</td>
<td>unknown cell</td>
<td>NBM</td>
<td>96.310960</td>
<td>92.693095</td>
<td>8.043118</td>
<td>199.984452</td>
</tr>
</tbody>
</table>

</div>

``` python
# Get top and bottom cell types for each unique region in the dataset.
unique_regions = df_all_edges_with_cell_type_level['Unique Region'].unique()
for region in unique_regions:
    top_bottom = get_top_bottom_cell_types_by_mean(df_all_edges_with_cell_type_level, cell_type_level, region)
    print(f"\nTop 5 cell types in {region}:")
    print(top_bottom[0])
    print(f"\nBottom 5 cell types in {region}:")
    print(top_bottom[1])
```


    Top 5 cell types in NSM:
                                 Level Three Cell Type  mean_distance
    10            granulocyte monocyte progenitor cell     113.471237
    12  hematopoietic stem and progenitor cell:spink2+     104.959083
    7                                     erythroblast      99.975515
    16                            megakaryocyte:gata1+      99.813171
    2                                  b cell:immature      97.478212

    Bottom 5 cell types in NSM:
                  Level Three Cell Type  mean_distance
    8           erythroblast:basophilic      69.175800
    6        endothelial cell of artery      65.333875
    22               muscle cell:smooth      55.313443
    3                  cell:cd34+ cd61+      54.635086
    14  lymphoid progenitor cell:common      48.644547

    Top 5 cell types in AML:
         Level Three Cell Type  mean_distance
    28            schwann cell     128.321993
    23       mutant blast:npm1      84.612826
    21  monocyte:non-classical      84.404224
    2          b cell:immature      82.461384
    29  t cell:cd4+ alpha-beta      82.044430

    Bottom 5 cell types in AML:
                                 Level Three Cell Type  mean_distance
    13                         hematopoietic stem cell      70.097786
    22                              muscle cell:smooth      69.735721
    6                       endothelial cell of artery      66.552461
    12  hematopoietic stem and progenitor cell:spink2+      54.563528
    8                          erythroblast:basophilic      52.951975

    Top 5 cell types in NBM:
                       Level Three Cell Type  mean_distance
    14       lymphoid progenitor cell:common     101.297912
    26                           plasma cell     100.456866
    10  granulocyte monocyte progenitor cell      99.994036
    17                  megakaryocyte:gata1-      99.683106
    2                        b cell:immature      99.501175

    Bottom 5 cell types in NBM:
                          Level Three Cell Type  mean_distance
    20                                 monocyte      91.803183
    18  mesenchymal stem cell of adipose tissue      91.666993
    21                   monocyte:non-classical      89.394134
    27                             schwann cell      86.411262
    6                endothelial cell of artery      80.875474

``` python
# Get top and bottom cell types for each unique region in the dataset.
unique_regions = df_all_edges_with_cell_type_level['Unique Region'].unique()
for region in unique_regions:
    top_bottom = get_top_bottom_cell_types_by_median(df_all_edges_with_cell_type_level, cell_type_level, region)
    print(f"\nTop 5 cell types in {region}:")
    print(top_bottom[0])
    print(f"\nBottom 5 cell types in {region}:")
    print(top_bottom[1])
```


    Top 5 cell types in NSM:
                                 Level Three Cell Type  median_distance
    10            granulocyte monocyte progenitor cell       118.935939
    12  hematopoietic stem and progenitor cell:spink2+        98.965058
    7                                     erythroblast        94.923044
    16                            megakaryocyte:gata1+        94.046165
    26                                     plasma cell        93.114820

    Bottom 5 cell types in NSM:
                  Level Three Cell Type  median_distance
    6        endothelial cell of artery        55.348929
    3                  cell:cd34+ cd61+        52.248486
    8           erythroblast:basophilic        50.068324
    14  lymphoid progenitor cell:common        48.644547
    22               muscle cell:smooth        46.465657

    Top 5 cell types in AML:
         Level Three Cell Type  median_distance
    28            schwann cell       128.321993
    23       mutant blast:npm1        78.755366
    21  monocyte:non-classical        77.154945
    20                monocyte        75.975206
    2          b cell:immature        75.703532

    Bottom 5 cell types in AML:
                                 Level Three Cell Type  median_distance
    3                                 cell:cd34+ cd61+        57.285741
    6                       endothelial cell of artery        57.188080
    8                          erythroblast:basophilic        49.722590
    12  hematopoietic stem and progenitor cell:spink2+        37.139774
    14                 lymphoid progenitor cell:common        33.321110

    Top 5 cell types in NBM:
                       Level Three Cell Type  median_distance
    14       lymphoid progenitor cell:common       103.775147
    26                           plasma cell        99.888396
    3                       cell:cd34+ cd61+        99.005114
    10  granulocyte monocyte progenitor cell        96.974877
    2                        b cell:immature        96.731118

    Bottom 5 cell types in NBM:
                      Level Three Cell Type  median_distance
    20                             monocyte        87.198437
    19  mesenchymal stem/stromal cell:thy1+        86.924087
    21               monocyte:non-classical        83.017617
    27                         schwann cell        78.933059
    6            endothelial cell of artery        71.598061

``` python
calculate_regional_variability(df_all_edges_with_cell_type_level, cell_type_level)
```


    Regional Variability Analysis:
    Mean: Average distance in each region
    Std: Standard deviation of distances
    CV: Coefficient of Variation (std/mean * 100%)
                    mean    std  CV (%)
    Unique Region                      
    AML            79.39  44.80    56.4
    NBM            95.30  48.83    51.2
    NSM            95.64  51.03    53.4

    Cell Type Variability Analysis (sorted by CV):
                                                      mean    std  CV (%)
    Level Three Cell Type                                                
    endothelial cell of artery                       77.69  52.16    67.1
    muscle cell:smooth                               87.24  50.87    58.3
    endosteal cell                                   92.68  52.72    56.9
    monocyte:non-classical                           88.77  50.37    56.7
    adipocyte                                        89.36  50.19    56.2
    mesenchymal stem cell of adipose tissue          87.59  48.55    55.4
    monocyte                                         89.70  49.59    55.3
    lymphoid progenitor cell:common                  97.64  53.83    55.1
    dendritic cell:plasmacytoid                      89.61  48.91    54.6
    mesenchymal stem/stromal cell:thy1+              89.52  48.91    54.6
    erythroblast:basophilic                          92.10  49.70    54.0
    t cell:cd4+ alpha-beta                           92.64  49.75    53.7
    granulocyte monocyte progenitor cell             87.89  47.14    53.6
    t cell:cd8+ alpha-beta regulatory                93.04  49.71    53.4
    myeloid cell:mature                              93.01  49.27    53.0
    hematopoietic stem and progenitor cell:spink2+   93.87  49.72    53.0
    cell:cd34+ cd61+                                 95.01  49.89    52.5
    mutant blast:npm1                                84.61  44.08    52.1
    erythroblast                                     90.48  47.17    52.1
    erythroid lineage cell                           92.67  48.17    52.0
    granulocyte monocyte progenitor cell/myeloblast  94.91  49.05    51.7
    myeloid cell:intermediate                        94.93  49.07    51.7
    b cell:immature                                  96.95  50.01    51.6
    b cell                                           94.57  48.82    51.6
    macrophage                                       92.25  47.60    51.6
    hematopoietic stem cell                          94.15  48.57    51.6
    megakaryocyte:gata1+                             90.24  46.49    51.5
    myeloid progenitor cell:common                   95.58  49.01    51.3
    plasma cell                                      94.90  48.57    51.2
    unknown cell                                     96.31  48.92    50.8
    schwann cell                                     87.43  43.59    49.9
    megakaryocyte:gata1-                             97.85  46.95    48.0

``` python
plot_violin_cells_per_celltype(df_all_edges_with_cell_type_level, cell_type_level, os.path.join(basepath, figures_output_dir), density_norm='area')
```

![](09_distance_analysis__bonemarrow-codex-chop_files/figure-commonmark/cell-47-output-1.png)

``` python
plot_distance_distribution_boxplots_by_region(df_all_edges_with_cell_type_level, cell_type_level, os.path.join(basepath, figures_output_dir))
```

![](09_distance_analysis__bonemarrow-codex-chop_files/figure-commonmark/cell-48-output-1.png)

``` python
plot_distance_distribution_heatmap(df_all_edges_with_cell_type_level, cell_type_level, os.path.join(basepath, figures_output_dir))
```

![](09_distance_analysis__bonemarrow-codex-chop_files/figure-commonmark/cell-49-output-1.png)

``` python
plot_violin_plots_all_regions(df_all_edges_with_cell_type_level, cell_type_level, os.path.join(basepath, figures_output_dir), density_norm="count") # Or, density_norm="count" or "area" based on preference.
```

![](09_distance_analysis__bonemarrow-codex-chop_files/figure-commonmark/cell-50-output-1.png)
